#!/usr/bin/env bash
# Git post-checkout ãƒ•ãƒƒã‚¯
#
# checkout ã¾ãŸã¯ worktree è¿½åŠ æ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
#
# å¼•æ•°:
# $1: å‰å›ã®HEAD ref
# $2: æ–°ã—ã„HEAD ref
# $3: ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆãƒ•ãƒ©ã‚° (1=ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆ, 0=ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ)

set -euo pipefail

readonly HOOKS_DIR="$(cd "$(dirname "$0")" && pwd)"
readonly SCRIPT_NAME="setup-worktree.sh"
readonly SCRIPT_PATH="$HOOKS_DIR/$SCRIPT_NAME"
readonly ZERO_SHA_REGEX='^0+$'

# ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆæ™‚($3=1) ã®ã¿å‡¦ç†å¯¾è±¡
if [[ "$3" != "1" ]]; then
    exit 0
fi

OLD_HEAD="$1"
GIT_DIR="$(git rev-parse --absolute-git-dir)"
COMMON_DIR="$(git rev-parse --git-common-dir)"

# linked worktree ä»¥å¤–ã§ã¯ä½•ã‚‚ã—ãªã„
if [[ "$GIT_DIR" == "$COMMON_DIR" ]]; then
    exit 0
fi

# worktree add ç›´å¾Œã®ã¿å®Ÿè¡Œï¼ˆé€šå¸¸ã® checkout ã¯é™¤å¤–ï¼‰
if [[ ! "$OLD_HEAD" =~ $ZERO_SHA_REGEX ]]; then
    exit 0
fi

WORKTREE_PATH="$(git rev-parse --show-toplevel)"
MAIN_REPO_PATH="$(dirname "$COMMON_DIR")"

if [[ ! -f "$SCRIPT_PATH" ]]; then
    echo "âš ï¸  Worktree ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $SCRIPT_PATH"
    exit 0
fi

echo ""
echo "=========================================="
echo "ğŸš€ Worktree ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™"
echo "=========================================="

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
bash "$SCRIPT_PATH" "$WORKTREE_PATH" "$MAIN_REPO_PATH" &

echo "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œä¸­..."
echo "ãƒ­ã‚°: tail -f $WORKTREE_PATH/.worktree-setup.log ã§ç¢ºèªã§ãã¾ã™"
