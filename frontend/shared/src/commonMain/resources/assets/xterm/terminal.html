<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal</title>
    <link rel="stylesheet" href="xterm.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #terminal-container { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="terminal-container"></div>
    <script src="xterm.js"></script>
    <script>
        (function() {
            'use strict';
            var terminal, websocket;
            var container = document.getElementById('terminal-container');

            function initTerminal() {
                var w = container.clientWidth || window.innerWidth || 800;
                var h = container.clientHeight || window.innerHeight || 600;
                var cols = Math.floor(w / 9) || 80;
                var rows = Math.floor(h / 18) || 24;

                terminal = new Terminal({
                    cols: cols, rows: rows, fontSize: 14, fontFamily: 'monospace',
                    theme: { background: '#1e1e1e', foreground: '#d4d4d4', cursor: '#ffffff' },
                    cursorBlink: true, scrollback: 1000
                });

                terminal.open(container);
                terminal.write('\x1b[32mTerminal ready\x1b[0m\r\n');

                // Force resize after delay to ensure rendering
                setTimeout(function() {
                    var w = container.clientWidth || window.innerWidth || 800;
                    var h = container.clientHeight || window.innerHeight || 600;
                    var cols = Math.floor(w / 9) || 80;
                    var rows = Math.floor(h / 18) || 24;
                    if (terminal) {
                        terminal.resize(cols, rows);
                    }
                }, 500);

                if (window.TerminalBridge && window.TerminalBridge.onTerminalReady) {
                    window.TerminalBridge.onTerminalReady();
                }
            }

            window.TerminalAPI = {
                connect: function(wsUrl, apiKey) {
                    websocket = new WebSocket(wsUrl);
                    websocket.onopen = function() {
                        websocket.send(JSON.stringify({type: 'auth', api_key: apiKey}));
                        if (window.TerminalBridge) window.TerminalBridge.onConnectionChanged(true);
                    };
                    websocket.onmessage = function(e) {
                        try {
                            var msg = JSON.parse(e.data);
                            if (msg.type === 'output' && msg.data_b64) {
                                var bin = atob(msg.data_b64);
                                var bytes = new Uint8Array(bin.length);
                                for (var i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                                terminal.write(new TextDecoder('utf-8').decode(bytes));
                            }
                        } catch(err) {}
                    };
                    websocket.onerror = function() {
                        if (window.TerminalBridge) window.TerminalBridge.onError('WS error');
                    };
                    websocket.onclose = function() {
                        if (window.TerminalBridge) window.TerminalBridge.onConnectionChanged(false);
                    };
                },
                disconnect: function() { if (websocket) { websocket.close(); websocket = null; } },
                sendKey: function(key) {
                    if (websocket && websocket.readyState === 1) {
                        websocket.send(JSON.stringify({type: 'input', data_b64: btoa(unescape(encodeURIComponent(key)))}));
                    }
                },
                setTheme: function(mode) {
                    if (terminal) terminal.options.theme = mode === 'light' ? 
                        {background: '#f8f9fb', foreground: '#1f2937'} : 
                        {background: '#1e1e1e', foreground: '#d4d4d4'};
                }
            };

            setTimeout(initTerminal, 100);
        })();
    </script>
</body>
</html>
