<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="vendor/xterm.5.5.0.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            overflow: hidden;
            touch-action: pan-y;
            overscroll-behavior: contain;
        }

        #xtermRender {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0;
            padding: 0px;
            box-sizing: border-box;
            background: #1e1e1e;
            touch-action: pan-y;
        }

        #xtermRender .xterm {
            width: 100%;
            height: 100%;
        }

        #xtermRender .xterm .xterm-viewport {
            height: 100%;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }

        #xtermRender .xterm .xterm-helper-textarea {
            position: fixed !important;
            left: -10000px !important;
            top: -10000px !important;
            width: 1px !important;
            height: 1px !important;
            opacity: 0 !important;
            z-index: -10 !important;
            border: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            caret-color: transparent !important;
            color: transparent !important;
            background: transparent !important;
        }
    </style>
</head>
<body>
    <div id="xtermRender"></div>
    <script src="vendor/xterm.5.5.0.js"></script>
    <script>
        (function() {
            var xtermRender = document.getElementById('xtermRender');
            var websocket = null;
            var renderTerminal = null;
            var touchScrollLastY = null;
            var touchScrollRemainder = 0;
            var pointerScrollLastY = null;
            var pointerDragActive = false;
            var viewportListenersBound = false;

            function reportError(message) {
                if (
                    window.TerminalBridge &&
                    typeof window.TerminalBridge.onError === 'function'
                ) {
                    window.TerminalBridge.onError(message);
                }
            }

            function focusTerminal() {
                if (renderTerminal && typeof renderTerminal.focus === 'function') {
                    renderTerminal.focus();
                }
            }

            function getXtermViewport() {
                if (!renderTerminal || !renderTerminal.element) {
                    return null;
                }
                return renderTerminal.element.querySelector('.xterm-viewport');
            }

            function getXtermRoot() {
                if (!renderTerminal || !renderTerminal.element) {
                    return null;
                }
                return renderTerminal.element;
            }

            function getCellHeight() {
                if (
                    renderTerminal &&
                    renderTerminal._core &&
                    renderTerminal._core._renderService &&
                    renderTerminal._core._renderService.dimensions &&
                    renderTerminal._core._renderService.dimensions.css &&
                    renderTerminal._core._renderService.dimensions.css.cell &&
                    renderTerminal._core._renderService.dimensions.css.cell.height > 0
                ) {
                    return renderTerminal._core._renderService.dimensions.css.cell.height;
                }
                return 18;
            }

            function scrollTerminalByPixels(pixelDelta) {
                if (!renderTerminal || !websocket || websocket.readyState !== 1) {
                    return false;
                }

                var cellHeight = Math.max(getCellHeight(), 1);
                touchScrollRemainder += pixelDelta;
                var lineDelta = Math.trunc(touchScrollRemainder / cellHeight);
                touchScrollRemainder -= lineDelta * cellHeight;

                if (lineDelta === 0) {
                    return false;
                }

                var steps = Math.min(Math.abs(lineDelta), 10);
                var isWheelUp = lineDelta < 0;
                var buttonCode = isWheelUp ? 64 : 65;
                var col = Math.max(1, Math.floor(renderTerminal.cols / 2));
                var row = Math.max(1, Math.floor(renderTerminal.rows / 2));
                var sgrSequence = '\u001b[<' + buttonCode + ';' + col + ';' + row + 'M';

                for (var i = 0; i < steps; i++) {
                    sendInput(sgrSequence);
                }
                return true;
            }

            function handleTouchScrollStart(event) {
                if (!event.touches || event.touches.length !== 1) {
                    touchScrollLastY = null;
                    return;
                }

                touchScrollLastY = event.touches[0].clientY;
            }

            function handleTouchScrollMove(event) {
                if (!event.touches || event.touches.length !== 1) {
                    touchScrollLastY = null;
                    return;
                }

                var currentY = event.touches[0].clientY;
                if (touchScrollLastY === null) {
                    touchScrollLastY = currentY;
                    return;
                }

                var deltaY = touchScrollLastY - currentY;
                if (Math.abs(deltaY) < 1) {
                    return;
                }

                var didScroll = scrollTerminalByPixels(deltaY);
                touchScrollLastY = currentY;
                if (didScroll) {
                    event.preventDefault();
                }
            }

            function handleTouchScrollEnd() {
                touchScrollLastY = null;
                touchScrollRemainder = 0;
            }

            function handleMouseWheelScroll(event) {
                if (!event || typeof event.deltaY !== 'number' || Math.abs(event.deltaY) < 1) {
                    return;
                }

                var didScroll = scrollTerminalByPixels(event.deltaY);
                if (didScroll) {
                    event.preventDefault();
                }
            }

            function handlePointerScrollStart(event) {
                if (!event) {
                    return;
                }

                pointerDragActive = true;
                pointerScrollLastY = event.clientY;
            }

            function handlePointerScrollMove(event) {
                if (!event || !pointerDragActive) {
                    return;
                }

                var currentY = event.clientY;
                if (pointerScrollLastY === null || typeof currentY !== 'number') {
                    pointerScrollLastY = currentY;
                    return;
                }

                var deltaY = pointerScrollLastY - currentY;
                if (Math.abs(deltaY) < 1) {
                    return;
                }

                var didScroll = scrollTerminalByPixels(deltaY);
                pointerScrollLastY = currentY;
                if (didScroll) {
                    event.preventDefault();
                }
            }

            function handlePointerScrollEnd() {
                pointerDragActive = false;
                pointerScrollLastY = null;
                touchScrollRemainder = 0;
            }

            function bindViewportScrollListeners() {
                if (viewportListenersBound) {
                    return;
                }

                var root = getXtermRoot();
                var viewport = getXtermViewport();
                if (!root) {
                    return;
                }

                root.addEventListener('touchstart', handleTouchScrollStart, { passive: true, capture: true });
                root.addEventListener('touchmove', handleTouchScrollMove, { passive: false, capture: true });
                root.addEventListener('touchend', handleTouchScrollEnd, { passive: true, capture: true });
                root.addEventListener('touchcancel', handleTouchScrollEnd, { passive: true, capture: true });
                root.addEventListener('wheel', handleMouseWheelScroll, { passive: false, capture: true });
                root.addEventListener('pointerdown', handlePointerScrollStart, { passive: true, capture: true });
                root.addEventListener('pointermove', handlePointerScrollMove, { passive: false, capture: true });
                root.addEventListener('pointerup', handlePointerScrollEnd, { passive: true, capture: true });
                root.addEventListener('pointercancel', handlePointerScrollEnd, { passive: true, capture: true });

                viewportListenersBound = true;
            }

            function ensureTerminal() {
                if (renderTerminal) {
                    return true;
                }
                if (typeof window.Terminal !== 'function') {
                    reportError('xterm.js is not available');
                    return false;
                }

                try {
                    renderTerminal = new window.Terminal({
                        cols: 80,
                        rows: 24,
                        scrollback: 5000,
                        convertEol: false,
                        cursorBlink: true,
                        cursorStyle: 'block',
                        cursorInactiveStyle: 'none',
                        drawWhitespace: 'none',
                        fontFamily: 'monospace',
                        fontSize: 14,
                        lineHeight: 1.2,
                        theme: {
                            background: '#1e1e1e',
                            foreground: '#d4d4d4',
                            cursor: '#d4d4d4',
                            cursorAccent: '#1e1e1e',
                        },
                    });
                    renderTerminal.open(xtermRender);
                    bindViewportScrollListeners();
                    if (typeof renderTerminal.onData === 'function') {
                        renderTerminal.onData(routeInput);
                    }

                    if (renderTerminal.textarea) {
                        renderTerminal.textarea.setAttribute('autocapitalize', 'off');
                        renderTerminal.textarea.setAttribute('autocomplete', 'off');
                        renderTerminal.textarea.setAttribute('autocorrect', 'off');
                        renderTerminal.textarea.setAttribute('spellcheck', 'false');
                        renderTerminal.textarea.style.caretColor = 'transparent';
                        renderTerminal.textarea.style.color = 'transparent';
                        renderTerminal.textarea.style.background = 'transparent';
                    }
                } catch (err) {
                    renderTerminal = null;
                    reportError('xterm initialization failed: ' + String(err));
                    return false;
                }

                return true;
            }

            function sendInput(data) {
                if (!data || !websocket || websocket.readyState !== 1) {
                    return;
                }

                websocket.send(JSON.stringify({
                    type: 'input',
                    data_b64: btoa(unescape(encodeURIComponent(data))),
                }));
            }

            function routeInput(data) {
                sendInput(data);
            }

            function estimateTerminalSize() {
                var cellWidth = 8.4;
                var cellHeight = 18.2;

                if (
                    renderTerminal &&
                    renderTerminal._core &&
                    renderTerminal._core._renderService &&
                    renderTerminal._core._renderService.dimensions &&
                    renderTerminal._core._renderService.dimensions.css &&
                    renderTerminal._core._renderService.dimensions.css.cell
                ) {
                    var cell = renderTerminal._core._renderService.dimensions.css.cell;
                    if (cell.width > 0) {
                        cellWidth = cell.width;
                    }
                    if (cell.height > 0) {
                        cellHeight = cell.height;
                    }
                }

                var cols = Math.floor((window.innerWidth) / cellWidth);
                var rows = Math.floor((window.innerHeight) / cellHeight);
                cols = Math.min(Math.max(cols, 20), 240);
                rows = Math.min(Math.max(rows, 12), 200);
                return { cols: cols, rows: rows };
            }

            function applyViewportSize() {
                var size = estimateTerminalSize();
                if (
                    renderTerminal &&
                    typeof renderTerminal.resize === 'function' &&
                    (renderTerminal.cols !== size.cols || renderTerminal.rows !== size.rows)
                ) {
                    renderTerminal.resize(size.cols, size.rows);
                }

                return size;
            }

            function sendResizeToServer() {
                var size = applyViewportSize();
                if (!websocket || websocket.readyState !== 1) {
                    return;
                }

                websocket.send(JSON.stringify({
                    type: 'resize',
                    cols: size.cols,
                    rows: size.rows,
                }));
            }

            function writeStreamChunkWithXterm(text) {
                if (!ensureTerminal() || typeof renderTerminal.write !== 'function') {
                    return false;
                }

                renderTerminal.write(text);
                return true;
            }

            function parseOutputMessage(message) {
                if (message.type !== 'output' || !message.data_b64) {
                    return;
                }

                var bin = atob(message.data_b64);
                var bytes = new Uint8Array(bin.length);
                for (var i = 0; i < bin.length; i++) {
                    bytes[i] = bin.charCodeAt(i);
                }
                var text = new TextDecoder('utf-8').decode(bytes);
                writeStreamChunkWithXterm(text);
            }

            xtermRender.addEventListener('click', function() {
                focusTerminal();
            });
            xtermRender.addEventListener('touchstart', function() {
                focusTerminal();
            }, { passive: true });

            window.TerminalAPI = {
                connect: function(wsUrl, apiKey) {
                    if (!ensureTerminal()) {
                        return;
                    }

                    if (websocket) {
                        websocket.close();
                    }

                    var ws = new WebSocket(wsUrl);
                    websocket = ws;

                    ws.onopen = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        ws.send(JSON.stringify({
                            type: 'auth',
                            api_key: apiKey,
                        }));
                        if (window.TerminalBridge) {
                            window.TerminalBridge.onConnectionChanged(true);
                        }
                        sendResizeToServer();
                        focusTerminal();
                    };
                    ws.onmessage = function(event) {
                        if (websocket !== ws) {
                            return;
                        }

                        try {
                            var message = JSON.parse(event.data);
                            parseOutputMessage(message);
                        } catch (err) {
                            reportError('Parse error: ' + String(err));
                        }
                    };
                    ws.onerror = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        reportError('WebSocket error');
                    };
                    ws.onclose = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        if (window.TerminalBridge) {
                            window.TerminalBridge.onConnectionChanged(false);
                        }
                        websocket = null;
                    };
                },
                disconnect: function() {
                    if (websocket) {
                        websocket.close();
                        websocket = null;
                    }
                },
                sendKey: function(key) {
                    sendInput(key);
                },
                scrollByPixels: function(pixelDelta) {
                    if (typeof pixelDelta !== 'number' || Math.abs(pixelDelta) < 1) {
                        return;
                    }
                    scrollTerminalByPixels(pixelDelta);
                },
            };

            if (window.TerminalBridge && window.TerminalBridge.onTerminalReady) {
                window.TerminalBridge.onTerminalReady();
            }

            if (ensureTerminal()) {
                applyViewportSize();
            }

            var resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    sendResizeToServer();
                }, 200);
            });
        })();
    </script>
</body>
</html>
