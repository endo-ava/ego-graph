<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin:0;padding:0;background:#1e1e1e;">
    <input type="text" id="hiddenInput" style="position:absolute;left:-9999px;opacity:0;" />
    <pre id="terminal" style="margin:0;padding:8px;background:#1e1e1e;color:#d4d4d4;font-family:monospace;font-size:14px;white-space:pre-wrap;word-wrap:break-word;"></pre>
    <div id="debug" style="position:fixed;top:0;left:0;background:yellow;color:black;font-size:10px;max-height:100px;overflow:auto;padding:4px;"></div>
    <script>
        (function() {
            var terminal = document.getElementById('terminal');
            var hiddenInput = document.getElementById('hiddenInput');
            var debug = document.getElementById('debug');
            var websocket;
            var messageCount = 0;
            
            function logDebug(msg) {
                messageCount++;
                debug.textContent = '[' + messageCount + '] ' + msg + '\n' + debug.textContent;
            }
            
            function appendText(text) {
                var cleaned = text.replace(/\x1b\[[0-9;]*m/g, '');
                logDebug('Append: ' + cleaned.length + ' bytes');
                terminal.textContent = cleaned;
                terminal.scrollTop = terminal.scrollHeight;
            }
            
            logDebug('Page loaded');

            terminal.addEventListener('click', function() {
                hiddenInput.focus();
            });

            hiddenInput.addEventListener('input', function(e) {
                var char = e.data || '';
                if (char && window.TerminalAPI) {
                    logDebug('Input: ' + char);
                    window.TerminalAPI.sendKey(char);
                }
                hiddenInput.value = '';
            });

            hiddenInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    logDebug('Key: Enter');
                    window.TerminalAPI.sendKey('\r');
                } else if (e.key === 'Backspace') {
                    e.preventDefault();
                    logDebug('Key: Backspace');
                    window.TerminalAPI.sendKey('\b');
                }
            });

            window.TerminalAPI = {
                connect: function(wsUrl, apiKey) {
                    logDebug('Connecting to: ' + wsUrl);
                    websocket = new WebSocket(wsUrl);
                    websocket.onopen = function() {
                        logDebug('Connected');
                        websocket.send(JSON.stringify({type: 'auth', api_key: apiKey}));
                        if (window.TerminalBridge) window.TerminalBridge.onConnectionChanged(true);
                    };
                    websocket.onmessage = function(e) {
                        try {
                            var msg = JSON.parse(e.data);
                            logDebug('Received: type=' + msg.type);
                            if (msg.type === 'output' && msg.data_b64) {
                                var bin = atob(msg.data_b64);
                                var bytes = new Uint8Array(bin.length);
                                for (var i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                                var text = new TextDecoder('utf-8').decode(bytes);
                                appendText(text);
                            }
                        } catch(err) {
                            logDebug('Error: ' + err);
                        }
                    };
                    websocket.onclose = function() {
                        logDebug('Closed');
                        if (window.TerminalBridge) window.TerminalBridge.onConnectionChanged(false);
                    };
                },
                disconnect: function() {
                    if (websocket) { websocket.close(); websocket = null; }
                },
                sendKey: function(key) {
                    if (websocket && websocket.readyState === 1) {
                        logDebug('Sending: ' + key.charCodeAt(0));
                        websocket.send(JSON.stringify({type: 'input', data_b64: btoa(unescape(encodeURIComponent(key)))}));
                    }
                }
            };

            if (window.TerminalBridge && window.TerminalBridge.onTerminalReady) {
                window.TerminalBridge.onTerminalReady();
            }

            hiddenInput.focus();
        })();
    </script>
</body>
</html>
