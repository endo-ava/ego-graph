<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="vendor/xterm.5.5.0.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            overflow: hidden;
        }

        #xtermRender {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0;
            padding: 8px;
            box-sizing: border-box;
            background: #1e1e1e;
        }

        #xtermRender .xterm {
            width: 100%;
            height: 100%;
        }

        #xtermRender .xterm .xterm-helper-textarea {
            /* Keep the helper textarea inside viewport to avoid WebView auto-scroll jumps on focus. */
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
            width: 1px !important;
            height: 1px !important;
            opacity: 0 !important;
            z-index: -5 !important;
            border: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            caret-color: transparent !important;
            color: transparent !important;
            background: transparent !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            resize: none !important;
        }
    </style>
</head>
<body>
    <div id="xtermRender"></div>
    <script src="vendor/xterm.5.5.0.js"></script>
    <script>
        (function() {
            var xtermRender = document.getElementById('xtermRender');
            var websocket = null;
            var renderTerminal = null;

            function reportError(message) {
                if (
                    window.TerminalBridge &&
                    typeof window.TerminalBridge.onError === 'function'
                ) {
                    window.TerminalBridge.onError(message);
                }
            }

            function focusTerminal() {
                if (renderTerminal && typeof renderTerminal.focus === 'function') {
                    renderTerminal.focus();
                }

                // Android WebView may try to keep focused input centered; force top-left origin.
                window.scrollTo(0, 0);
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            }

            function ensureTerminal() {
                if (renderTerminal) {
                    return true;
                }
                if (typeof window.Terminal !== 'function') {
                    reportError('xterm.js is not available');
                    return false;
                }

                try {
                    renderTerminal = new window.Terminal({
                        cols: 80,
                        rows: 24,
                        convertEol: false,
                        cursorBlink: true,
                        cursorStyle: 'block',
                        cursorInactiveStyle: 'none',
                        drawWhitespace: 'none',
                        fontFamily: 'monospace',
                        fontSize: 14,
                        lineHeight: 1.2,
                        theme: {
                            background: '#1e1e1e',
                            foreground: '#d4d4d4',
                            cursor: '#d4d4d4',
                            cursorAccent: '#1e1e1e',
                        },
                    });
                    renderTerminal.open(xtermRender);
                    if (typeof renderTerminal.onData === 'function') {
                        renderTerminal.onData(routeInput);
                    }

                    if (renderTerminal.textarea) {
                        renderTerminal.textarea.setAttribute('autocapitalize', 'off');
                        renderTerminal.textarea.setAttribute('autocomplete', 'off');
                        renderTerminal.textarea.setAttribute('autocorrect', 'off');
                        renderTerminal.textarea.setAttribute('spellcheck', 'false');
                        renderTerminal.textarea.style.position = 'absolute';
                        renderTerminal.textarea.style.left = '0px';
                        renderTerminal.textarea.style.top = '0px';
                        renderTerminal.textarea.style.width = '1px';
                        renderTerminal.textarea.style.height = '1px';
                        renderTerminal.textarea.style.caretColor = 'transparent';
                        renderTerminal.textarea.style.color = 'transparent';
                        renderTerminal.textarea.style.background = 'transparent';
                    }
                } catch (err) {
                    renderTerminal = null;
                    reportError('xterm initialization failed: ' + String(err));
                    return false;
                }

                return true;
            }

            function sendInput(data) {
                if (!data || !websocket || websocket.readyState !== 1) {
                    return;
                }

                websocket.send(JSON.stringify({
                    type: 'input',
                    data_b64: btoa(unescape(encodeURIComponent(data))),
                }));
            }

            function routeInput(data) {
                sendInput(data);
            }

            function estimateTerminalSize() {
                var cellWidth = 8.4;
                var cellHeight = 18.2;

                if (
                    renderTerminal &&
                    renderTerminal._core &&
                    renderTerminal._core._renderService &&
                    renderTerminal._core._renderService.dimensions &&
                    renderTerminal._core._renderService.dimensions.css &&
                    renderTerminal._core._renderService.dimensions.css.cell
                ) {
                    var cell = renderTerminal._core._renderService.dimensions.css.cell;
                    if (cell.width > 0) {
                        cellWidth = cell.width;
                    }
                    if (cell.height > 0) {
                        cellHeight = cell.height;
                    }
                }

                var cols = Math.floor((window.innerWidth - 16) / cellWidth);
                var rows = Math.floor((window.innerHeight - 16) / cellHeight);
                cols = Math.min(Math.max(cols, 20), 240);
                rows = Math.min(Math.max(rows, 12), 200);
                return { cols: cols, rows: rows };
            }

            function applyViewportSize() {
                var size = estimateTerminalSize();
                if (
                    renderTerminal &&
                    typeof renderTerminal.resize === 'function' &&
                    (renderTerminal.cols !== size.cols || renderTerminal.rows !== size.rows)
                ) {
                    renderTerminal.resize(size.cols, size.rows);
                }

                return size;
            }

            function sendResizeToServer() {
                var size = applyViewportSize();
                if (!websocket || websocket.readyState !== 1) {
                    return;
                }

                websocket.send(JSON.stringify({
                    type: 'resize',
                    cols: size.cols,
                    rows: size.rows,
                }));
            }

            function writeStreamChunkWithXterm(text) {
                if (!ensureTerminal() || typeof renderTerminal.write !== 'function') {
                    return false;
                }

                renderTerminal.write(text);
                return true;
            }

            function parseOutputMessage(message) {
                if (message.type !== 'output' || !message.data_b64) {
                    return;
                }

                var bin = atob(message.data_b64);
                var bytes = new Uint8Array(bin.length);
                for (var i = 0; i < bin.length; i++) {
                    bytes[i] = bin.charCodeAt(i);
                }
                var text = new TextDecoder('utf-8').decode(bytes);
                writeStreamChunkWithXterm(text);
            }

            function getEstimatedCellHeight() {
                if (
                    renderTerminal &&
                    renderTerminal._core &&
                    renderTerminal._core._renderService &&
                    renderTerminal._core._renderService.dimensions &&
                    renderTerminal._core._renderService.dimensions.css &&
                    renderTerminal._core._renderService.dimensions.css.cell &&
                    renderTerminal._core._renderService.dimensions.css.cell.height > 0
                ) {
                    return renderTerminal._core._renderService.dimensions.css.cell.height;
                }

                return 18.2;
            }

            var touchScrollState = {
                startX: 0,
                startY: 0,
                lastY: 0,
                accumulatedPixels: 0,
                isVerticalGesture: null,
            };

            function resetTouchScrollState() {
                touchScrollState.accumulatedPixels = 0;
                touchScrollState.isVerticalGesture = null;
            }

            xtermRender.addEventListener('click', function() {
                focusTerminal();
            });

            xtermRender.addEventListener('touchstart', function(event) {
                focusTerminal();

                if (!event.touches || event.touches.length !== 1) {
                    resetTouchScrollState();
                    return;
                }

                var touch = event.touches[0];
                touchScrollState.startX = touch.clientX;
                touchScrollState.startY = touch.clientY;
                touchScrollState.lastY = touch.clientY;
                touchScrollState.accumulatedPixels = 0;
                touchScrollState.isVerticalGesture = null;
            }, { passive: true });

            xtermRender.addEventListener('touchmove', function(event) {
                if (!renderTerminal || !event.touches || event.touches.length !== 1) {
                    return;
                }

                var touch = event.touches[0];
                var deltaX = touch.clientX - touchScrollState.startX;
                var deltaY = touch.clientY - touchScrollState.startY;

                if (touchScrollState.isVerticalGesture === null) {
                    if (Math.abs(deltaX) < 4 && Math.abs(deltaY) < 4) {
                        return;
                    }
                    touchScrollState.isVerticalGesture = Math.abs(deltaY) >= Math.abs(deltaX);
                }

                if (!touchScrollState.isVerticalGesture) {
                    return;
                }

                event.preventDefault();

                var movedY = touch.clientY - touchScrollState.lastY;
                touchScrollState.lastY = touch.clientY;
                touchScrollState.accumulatedPixels += movedY;

                var cellHeight = getEstimatedCellHeight();
                if (cellHeight <= 0) {
                    return;
                }

                var lines = Math.trunc(touchScrollState.accumulatedPixels / cellHeight);
                if (lines !== 0 && typeof renderTerminal.scrollLines === 'function') {
                    // Finger down should reveal older output, so invert scroll direction.
                    renderTerminal.scrollLines(-lines);
                    touchScrollState.accumulatedPixels -= lines * cellHeight;
                }
            }, { passive: false });

            xtermRender.addEventListener('touchend', function() {
                resetTouchScrollState();
            }, { passive: true });

            xtermRender.addEventListener('touchcancel', function() {
                resetTouchScrollState();
            }, { passive: true });

            window.TerminalAPI = {
                connect: function(wsUrl, apiKey) {
                    if (!ensureTerminal()) {
                        return;
                    }

                    if (websocket) {
                        websocket.close();
                    }

                    var ws = new WebSocket(wsUrl);
                    websocket = ws;

                    ws.onopen = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        ws.send(JSON.stringify({
                            type: 'auth',
                            api_key: apiKey,
                        }));
                        if (window.TerminalBridge) {
                            window.TerminalBridge.onConnectionChanged(true);
                        }
                        sendResizeToServer();
                        focusTerminal();
                    };
                    ws.onmessage = function(event) {
                        if (websocket !== ws) {
                            return;
                        }

                        try {
                            var message = JSON.parse(event.data);
                            parseOutputMessage(message);
                        } catch (err) {
                            reportError('Parse error: ' + String(err));
                        }
                    };
                    ws.onerror = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        reportError('WebSocket error');
                    };
                    ws.onclose = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        if (window.TerminalBridge) {
                            window.TerminalBridge.onConnectionChanged(false);
                        }
                        websocket = null;
                    };
                },
                disconnect: function() {
                    if (websocket) {
                        websocket.close();
                        websocket = null;
                    }
                },
                sendKey: function(key) {
                    sendInput(key);
                },
            };

            if (window.TerminalBridge && window.TerminalBridge.onTerminalReady) {
                window.TerminalBridge.onTerminalReady();
            }

            if (ensureTerminal()) {
                applyViewportSize();
            }

            var resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    sendResizeToServer();
                }, 200);
            });
        })();
    </script>
</body>
</html>
