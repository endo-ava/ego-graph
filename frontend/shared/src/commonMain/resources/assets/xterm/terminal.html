<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="vendor/xterm.5.5.0.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            overflow: hidden;
        }

        #xtermRender {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0;
            padding: 8px;
            box-sizing: border-box;
            background: #1e1e1e;
        }

        #xtermRender .xterm {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="xtermRender"></div>
    <script src="vendor/xterm.5.5.0.js"></script>
    <script>
        (function() {
            var xtermRender = document.getElementById('xtermRender');
            var websocket = null;
            var renderTerminal = null;
            var ANSI_ESCAPE_RE = /\x1b\[[0-9;?]*[ -/]*[@-~]/g;

            function reportError(message) {
                if (
                    window.TerminalBridge &&
                    typeof window.TerminalBridge.onError === 'function'
                ) {
                    window.TerminalBridge.onError(message);
                }
            }

            function safeScrollToBottom() {
                if (renderTerminal && typeof renderTerminal.scrollToBottom === 'function') {
                    renderTerminal.scrollToBottom();
                }
            }

            function focusTerminal() {
                if (renderTerminal && typeof renderTerminal.focus === 'function') {
                    renderTerminal.focus();
                }
            }

            function ensureTerminal() {
                if (renderTerminal) {
                    return true;
                }
                if (typeof window.Terminal !== 'function') {
                    reportError('xterm.js is not available');
                    return false;
                }

                try {
                    renderTerminal = new window.Terminal({
                        cols: 80,
                        rows: 24,
                        convertEol: true,
                        cursorBlink: false,
                        fontFamily: 'monospace',
                        fontSize: 14,
                        lineHeight: 1.2,
                        theme: {
                            background: '#1e1e1e',
                            foreground: '#d4d4d4',
                        },
                    });
                    renderTerminal.open(xtermRender);
                    if (typeof renderTerminal.onData === 'function') {
                        renderTerminal.onData(routeInput);
                    }

                    if (renderTerminal.textarea) {
                        renderTerminal.textarea.setAttribute('autocapitalize', 'off');
                        renderTerminal.textarea.setAttribute('autocomplete', 'off');
                        renderTerminal.textarea.setAttribute('autocorrect', 'off');
                        renderTerminal.textarea.setAttribute('spellcheck', 'false');
                    }
                } catch (err) {
                    renderTerminal = null;
                    reportError('xterm initialization failed: ' + String(err));
                    return false;
                }

                return true;
            }

            function sendInput(data) {
                if (!data || !websocket || websocket.readyState !== 1) {
                    return;
                }

                websocket.send(JSON.stringify({
                    type: 'input',
                    data_b64: btoa(unescape(encodeURIComponent(data))),
                }));
            }

            function routeInput(data) {
                sendInput(data);
            }

            function estimateTerminalSize() {
                var cols = Math.floor((window.innerWidth - 16) / 8.4);
                var rows = Math.floor((window.innerHeight - 16) / 18.2);
                cols = Math.min(Math.max(cols, 20), 240);
                rows = Math.min(Math.max(rows, 12), 200);
                return { cols: cols, rows: rows };
            }

            function applyViewportSize() {
                var size = estimateTerminalSize();
                if (
                    renderTerminal &&
                    typeof renderTerminal.resize === 'function'
                ) {
                    renderTerminal.resize(size.cols, size.rows);
                }
                return size;
            }

            function sendResizeToServer() {
                var size = applyViewportSize();
                if (!websocket || websocket.readyState !== 1) {
                    return;
                }

                websocket.send(JSON.stringify({
                    type: 'resize',
                    cols: size.cols,
                    rows: size.rows,
                }));
            }

            function renderSnapshotWithXterm(text, cursorX, cursorY, paneRows) {
                if (!ensureTerminal()) {
                    return false;
                }

                var normalized = String(text || '')
                    .replace(/\u0000/g, '')
                    .replace(/\r/g, '');
                var lines = normalized.split('\n');

                if (lines.length > 1 && lines[lines.length - 1] === '') {
                    lines.pop();
                }
                if (lines.length === 0) {
                    lines = [''];
                }
                if (
                    typeof paneRows === 'number' &&
                    paneRows > 0 &&
                    lines.length > paneRows
                ) {
                    lines = lines.slice(lines.length - paneRows);
                }

                var rows = Math.max(
                    typeof paneRows === 'number' && paneRows > 0 ? paneRows : 24,
                    12
                );
                var cols = 80;
                for (var i = 0; i < lines.length; i++) {
                    var plainLength = lines[i].replace(ANSI_ESCAPE_RE, '').length;
                    if (plainLength + 1 > cols) {
                        cols = plainLength + 1;
                    }
                }
                cols = Math.min(Math.max(cols, 20), 240);

                if (typeof renderTerminal.resize === 'function') {
                    renderTerminal.resize(cols, rows);
                }
                if (typeof renderTerminal.reset === 'function') {
                    renderTerminal.reset();
                } else if (typeof renderTerminal.clear === 'function') {
                    renderTerminal.clear();
                }
                if (typeof renderTerminal.write !== 'function') {
                    return false;
                }

                renderTerminal.write(lines.join('\r\n'));
                if (
                    typeof cursorX === 'number' &&
                    typeof cursorY === 'number' &&
                    cursorX >= 0 &&
                    cursorY >= 0
                ) {
                    renderTerminal.write(
                        '\x1b[' + (cursorY + 1) + ';' + (cursorX + 1) + 'H'
                    );
                }

                safeScrollToBottom();
                return true;
            }

            function writeStreamChunkWithXterm(text) {
                if (!ensureTerminal() || typeof renderTerminal.write !== 'function') {
                    return false;
                }

                renderTerminal.write(text);
                safeScrollToBottom();
                return true;
            }

            function parseOutputMessage(message) {
                if (message.type !== 'output' || !message.data_b64) {
                    return;
                }

                var bin = atob(message.data_b64);
                var bytes = new Uint8Array(bin.length);
                for (var i = 0; i < bin.length; i++) {
                    bytes[i] = bin.charCodeAt(i);
                }
                var text = new TextDecoder('utf-8').decode(bytes);
                var isSnapshot = message.is_snapshot === true;

                if (isSnapshot) {
                    renderSnapshotWithXterm(
                        text,
                        message.cursor_x,
                        message.cursor_y,
                        message.pane_rows
                    );
                    return;
                }

                writeStreamChunkWithXterm(text);
            }

            xtermRender.addEventListener('click', function() {
                focusTerminal();
            });
            xtermRender.addEventListener('touchstart', function() {
                focusTerminal();
            }, { passive: true });

            window.TerminalAPI = {
                connect: function(wsUrl, apiKey) {
                    if (!ensureTerminal()) {
                        return;
                    }

                    if (websocket) {
                        websocket.close();
                    }

                    var ws = new WebSocket(wsUrl);
                    websocket = ws;

                    ws.onopen = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        ws.send(JSON.stringify({
                            type: 'auth',
                            api_key: apiKey,
                        }));
                        if (window.TerminalBridge) {
                            window.TerminalBridge.onConnectionChanged(true);
                        }
                        sendResizeToServer();
                        focusTerminal();
                    };
                    ws.onmessage = function(event) {
                        if (websocket !== ws) {
                            return;
                        }

                        try {
                            var message = JSON.parse(event.data);
                            parseOutputMessage(message);
                        } catch (err) {
                            reportError('Parse error: ' + String(err));
                        }
                    };
                    ws.onerror = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        reportError('WebSocket error');
                    };
                    ws.onclose = function() {
                        if (websocket !== ws) {
                            return;
                        }

                        if (window.TerminalBridge) {
                            window.TerminalBridge.onConnectionChanged(false);
                        }
                        websocket = null;
                    };
                },
                disconnect: function() {
                    if (websocket) {
                        websocket.close();
                        websocket = null;
                    }
                },
                sendKey: function(key) {
                    sendInput(key);
                },
            };

            if (window.TerminalBridge && window.TerminalBridge.onTerminalReady) {
                window.TerminalBridge.onTerminalReady();
            }

            if (ensureTerminal()) {
                applyViewportSize();
                safeScrollToBottom();
            }

            var resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    sendResizeToServer();
                }, 200);
            });
        })();
    </script>
</body>
</html>
