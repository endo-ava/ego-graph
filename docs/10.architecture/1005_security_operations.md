# セキュリティ・運用

## 1. セキュリティ設計の基本方針

### 1.1 プライバシーファースト原則

すべての設計判断において、プライバシー保護を最優先する。

- **最小権限の原則**：必要最小限のデータアクセスのみ許可
- **データ分離**：機密データはPrivate DBに物理的に隔離
- **暗号化**：通信・保存の両方で暗号化
- **透明性**：ユーザーが自分のデータを完全に把握・制御できる

### 1.2 ゼロトラストアーキテクチャ

- すべてのアクセスを認証・認可
- ネットワーク境界に依存しない
- 継続的な監視と検証

---

## 2. セキュリティ対策

### 2.1 通信セキュリティ

| 対策 | 実装 |
|---|---|
| **TLS暗号化** | すべてのHTTP通信をHTTPSに強制 |
| **証明書管理** | Let's Encrypt（自動更新） |
| **HSTS** | Strict-Transport-Security ヘッダー |
| **API認証** | Bearer Token（JWT） |

### 2.2 データ保護

#### 保存時の暗号化

| データ | 暗号化方式 |
|---|---|
| **Qdrant Cloud** | AES-256（サービス提供） |
| **Qdrant on NAS** | LUKS（ディスク暗号化） |
| **バックアップ** | GPG暗号化後にS3へアップロード |

#### 転送時の暗号化

- すべてのAPI通信：TLS 1.3
- NAS接続：VPN（WireGuard）

### 2.3 Secrets管理

#### Phase 1（MVP）

```
GitHub Secrets
├── SPOTIFY_CLIENT_ID
├── SPOTIFY_CLIENT_SECRET
├── QDRANT_API_KEY
└── QDRANT_URL
```

**セキュリティ対策**：

- Secretsはリポジトリオーナーのみアクセス可能
- ログに出力しない（GitHub Actionsのマスキング機能）
- 定期的なキーローテーション（3ヶ月ごと）

#### Phase 2（本格運用）

HashiCorp Vaultへ移行：

- 動的シークレット生成
- 監査ログ
- 細かいアクセス制御

### 2.4 認証・認可

#### ユーザー認証

- **認証基盤**：Supabase Auth
- **認証方式**：
  - Email/Password
  - OAuth（Google, GitHub）
- **MFA**：TOTP（Google Authenticator）

#### API認可

```
User Request
    ↓
Supabase Auth（JWT検証）
    ↓
FastAPI（スコープチェック）
    ↓
Vector DB Router（データアクセス制御）
```

### 2.5 入力検証

| レイヤー | 検証内容 |
|---|---|
| **Frontend** | クライアントサイドバリデーション（UX向上） |
| **Backend** | Pydanticモデルで型・範囲チェック |
| **DB** | Qdrantのスキーマ検証 |

**SQLインジェクション対策**：

- ORMを使用（SQLAlchemy）
- 生のSQLクエリは禁止

**XSS対策**：

- React（Next.js）のエスケープ機能
- `Content-Security-Policy`ヘッダー

### 2.6 レート制限

| エンドポイント | 制限 |
|---|---|
| `/api/query` | 10req/min/user |
| `/api/ingest` | 100req/min/system |
| `/auth/login` | 5req/min/IP |

**実装**：FastAPI middleware（`slowapi`）

### 2.7 監査ログ

#### 記録対象

- [ ] ユーザーログイン/ログアウト
- [ ] データアクセス（検索クエリ）
- [ ] データ変更（追加・削除）
- [ ] 設定変更

#### ログフォーマット

```json
{
  "timestamp": "2023-12-11T15:00:00Z",
  "user_id": "uuid",
  "action": "query",
  "resource": "qdrant:public",
  "query": "最近聴いた曲",
  "result_count": 10,
  "ip_address": "xxx.xxx.xxx.xxx"
}
```

#### 保存期間

- **アクティブログ**：90日間（検索可能）
- **アーカイブログ**：1年間（S3 Glacier）

---

## 3. プライバシー保護

### 3.1 データ分離戦略

```
┌─────────────────────────────────────┐
│         Sensitivity: High           │
│  (Bank, Adult, Location, Medical)   │
│                                     │
│   ┌─────────────────────────────┐   │
│   │   Qdrant on NAS (Private)   │   │
│   │   - VPN経由のみアクセス       │   │
│   │   - ディスク暗号化           │   │
│   └─────────────────────────────┘   │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      Sensitivity: Low/Medium        │
│   (Spotify, Calendar, Note, etc)    │
│                                     │
│   ┌─────────────────────────────┐   │
│   │   Qdrant Cloud (Public)     │   │
│   │   - TLS暗号化               │   │
│   │   - マネージド               │   │
│   └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 3.2 PIIマスキング

#### LLM送信前の処理

```python
# 例：銀行取引データ
original = "山田太郎さんの口座（1234567890）から50,000円出金"
masked = "[Name]さんの口座（[Account]）から50,000円出金"
```

**マスク対象**：

- 氏名
- 住所
- 電話番号
- 口座番号
- クレジットカード番号
- メールアドレス（ドメイン以外）

#### マスキングエンジン

- 正規表現ベース（Phase 1）
- NER（Named Entity Recognition）モデル（Phase 2）

### 3.3 NSFWコンテンツ管理

#### 判定基準

- `source == "adult"` → 自動的にNSFW
- Spotify `explicit` フラグ → NSFW
- テキスト内容解析（将来）

#### アクセス制御

| モード | NSFWコンテンツ |
|---|---|
| **Personalモード** | アクセス可能 |
| **Workモード** | 除外 |
| **Presentationモード** | 除外 |

**実装**：メタデータフィルタで自動除外

### 3.4 データ削除ポリシー

#### ユーザー要求による削除

1. **即時論理削除**：検索から除外（`deleted: true`）
2. **30日後に物理削除**：DB領域から完全削除
3. **バックアップからも削除**：次回バックアップ時に除外

#### 自動削除（将来）

- 設定した保持期間を超えたデータ
- 例：ブラウザ履歴は1年後に自動削除

---

## 4. バックアップ・災害復旧

### 4.1 バックアップ戦略

#### Qdrant Cloud（Public）

- **バックアップ**：サービス提供（自動）
- **復元**：Qdrantの管理画面から

#### Qdrant on NAS（Private）

| 種類 | 頻度 | 保持期間 | 保存先 |
|---|---|---|---|
| **フルバックアップ** | 週次（日曜深夜） | 3ヶ月 | S3 + NAS内別ディスク |
| **差分バックアップ** | 日次（深夜2時） | 30日 | NAS内別ディスク |
| **スナップショット** | 手動（重要作業前） | 無期限 | S3 |

#### バックアップ手順

```bash
# 1. Qdrantデータをダンプ
qdrant-client dump --output /backup/qdrant_YYYYMMDD.tar.gz

# 2. GPGで暗号化
gpg --encrypt --recipient ego-graph-backup /backup/qdrant_YYYYMMDD.tar.gz

# 3. S3へアップロード
aws s3 cp /backup/qdrant_YYYYMMDD.tar.gz.gpg s3://ego-graph-backup/

# 4. ローカルバックアップはNAS別ディスクへコピー
cp /backup/qdrant_YYYYMMDD.tar.gz.gpg /mnt/backup_disk/
```

### 4.2 災害復旧計画（DR Plan）

#### RPO（Recovery Point Objective）

- **Qdrant Cloud**：最大1時間（サービス提供）
- **Qdrant on NAS**：最大24時間（日次バックアップ）

#### RTO（Recovery Time Objective）

- **Qdrant Cloud**：数分（サービス提供）
- **Qdrant on NAS**：4時間以内（手動復旧）

#### 復旧手順

1. **バックアップからの復元**：
   - S3から最新バックアップをダウンロード
   - GPGで復号化
   - Qdrantへインポート

2. **動作確認**：
   - サンプルクエリで検索確認
   - データ件数の整合性確認

3. **サービス再開**：
   - Frontend/Backendの再起動

### 4.3 オフサイトバックアップ

- **保存先**：AWS S3 Glacier（東京リージョン + 別リージョン）
- **暗号化**：GPG（AES-256）
- **アクセス制御**：IAMで最小権限

---

## 5. 監視・アラート

### 5.1 監視対象

| 項目 | 監視内容 | 閾値 |
|---|---|---|
| **API応答時間** | `/api/query`のレイテンシ | 95%ile < 500ms |
| **エラー率** | 5xx エラーの発生率 | < 1% |
| **DB容量** | Qdrantのディスク使用率 | < 80% |
| **バックアップ成功率** | 日次バックアップの成功 | 100% |
| **認証失敗** | ログイン失敗回数 | 10回/10分でアラート |

### 5.2 監視ツール

| ツール | 用途 |
|---|---|
| **Prometheus** | メトリクス収集 |
| **Grafana** | ダッシュボード可視化 |
| **Alertmanager** | アラート通知 |

### 5.3 アラート通知

- **通知先**：Email, Slack, Discord
- **重要度別**：
  - **Critical**：即座に対応（例：DB停止）
  - **Warning**：24時間以内に確認（例：ディスク容量80%）
  - **Info**：記録のみ（例：バックアップ成功）

---

## 6. 運用手順

### 6.1 定期メンテナンス

| 作業 | 頻度 | 内容 |
|---|---|---|
| **依存関係更新** | 月次 | `pip update`, `npm update` |
| **セキュリティパッチ** | 即時 | 脆弱性発見時に即座に適用 |
| **ログローテーション** | 週次 | 古いログをアーカイブ |
| **バックアップ検証** | 月次 | ランダムにバックアップを復元して確認 |
| **APIキーローテーション** | 3ヶ月ごと | すべてのAPIキーを更新 |

### 6.2 インシデント対応

#### 検知

- 監視アラート受信
- ユーザーからの報告
- ログ分析

#### 初動対応（30分以内）

1. 影響範囲の特定
2. 緊急性の評価
3. 関係者への通知

#### 復旧対応

1. 原因調査
2. 修正実施
3. 動作確認
4. サービス再開

#### 事後対応

1. インシデントレポート作成
2. 再発防止策の検討
3. ドキュメント更新

### 6.3 データ取り込みオペレーション

#### GitHub Actionsの監視

- **成功率**：週次で確認
- **失敗時**：リトライ（最大3回）
- **連続失敗**：Slack通知

#### 手動トリガー

```bash
# GitHub CLIで手動実行
gh workflow run spotify-ingest.yml
```

### 6.4 ログ管理

#### ログレベル

| レベル | 用途 |
|---|---|
| **DEBUG** | 開発時のみ |
| **INFO** | 通常動作のログ |
| **WARNING** | 注意が必要な事象 |
| **ERROR** | エラー発生 |
| **CRITICAL** | システム停止級 |

#### ログ保存

- **アプリケーションログ**：`/var/log/ego-graph/`
- **アクセスログ**：FastAPIのミドルウェアで記録
- **監査ログ**：別ファイル（重要）

---

## 7. コンプライアンス

### 7.1 GDPR（参考）

本システムは個人専用だが、将来の拡張に備えて以下を考慮：

- [ ] データポータビリティ（エクスポート機能）
- [ ] 削除権（データ削除機能）
- [ ] アクセス権（データ閲覧機能）
- [ ] データ処理の透明性（何を保存しているか表示）

### 7.2 データ主権

- すべてのデータは自己管理
- 第三者サービスへの依存を最小化
- いつでもシステムを完全停止・削除可能

---

## 8. セキュリティチェックリスト

### 8.1 初期構築時

- [ ] すべてのAPIキーをGitHub Secretsに格納
- [ ] HTTPS強制設定
- [ ] Qdrant on NASのVPN設定
- [ ] ディスク暗号化（LUKS）
- [ ] バックアップ自動化設定
- [ ] 監視ダッシュボード構築

### 8.2 運用中

- [ ] 週次でアクセスログ確認
- [ ] 月次でバックアップ検証
- [ ] 3ヶ月ごとにAPIキーローテーション
- [ ] 依存関係の脆弱性スキャン（Dependabot）

### 8.3 インシデント発生時

- [ ] 即座にサービス停止（必要な場合）
- [ ] ログの確保
- [ ] 影響範囲の特定
- [ ] インシデントレポート作成

---

## 9. 今後の改善計画

### Phase 2

- [ ] HashiCorp Vault導入
- [ ] SOC（Security Operations Center）構築
- [ ] 侵入検知システム（IDS）
- [ ] 定期的なペネトレーションテスト

### Phase 3

- [ ] ゼロトラスト認証の強化
- [ ] データのエンドツーエンド暗号化
- [ ] マルチリージョン冗長化

---

## 参考

- [データモデル](./1002_data_model.md)
- [システムアーキテクチャ](./1001_system_architecture.md)
- [技術スタック](./1004_tech_stack.md)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
