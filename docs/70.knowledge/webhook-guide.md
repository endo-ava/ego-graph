# Webhook & Push Notification ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ Webhook ã®åŸºç¤æ¦‚å¿µã¨ EgoGraph ã§ã®ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ä»•çµ„ã¿ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

---

## ãƒ‘ãƒ¼ãƒˆ1: Webhook ã¨ã¯

Webhookï¼ˆã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ï¼‰ã¯ã€Œã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚’ HTTP çµŒç”±ã§é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã€ã§ã™ã€‚ã€Œé€†ãƒãƒ¼ãƒªãƒ³ã‚°ã€ã¨ã‚‚å‘¼ã°ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®èƒ½å‹•çš„ãªé€šçŸ¥ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### ãƒãƒ¼ãƒªãƒ³ã‚° vs Webhook

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€ãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ï¼ˆå¾“æ¥ï¼‰ã€‘                                            â”‚
â”‚                                                                     â”‚
â”‚  ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                    ã‚µãƒ¼ãƒãƒ¼                             â”‚
â”‚    â”‚                              â”‚                                  â”‚
â”‚    â”‚ ã€Œä½•ã‹æ–°ã—ã„ã“ã¨ã‚ã‚‹ï¼Ÿã€        â”‚                                  â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                                  â”‚
â”‚    â”‚                              â”‚ ã€Œãªã„ã‚ˆã€                        â”‚
â”‚    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
â”‚    â”‚     ï¼ˆæ•°ç§’å¾Œï¼‰                                                  â”‚
â”‚    â”‚                              â”‚                                  â”‚
â”‚    â”‚ ã€Œä½•ã‹æ–°ã—ã„ã“ã¨ã‚ã‚‹ï¼Ÿã€        â”‚                                  â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                                  â”‚
â”‚    â”‚                              â”‚ ã€Œãªã„ã‚ˆã€                        â”‚
â”‚    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
â”‚                                                                     â”‚
â”‚  â€» ç„¡é§„ãªé€šä¿¡ãŒå¤šãã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã«æ¬ ã‘ã‚‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€Webhook æ–¹å¼ã€‘                                                      â”‚
â”‚                                                                     â”‚
â”‚  ã‚µãƒ¼ãƒ“ã‚¹A                      ã‚µãƒ¼ãƒ“ã‚¹B                            â”‚
â”‚    â”‚                              â”‚                                  â”‚
â”‚    â”‚ ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼                  â”‚                                  â”‚
â”‚    â”‚                              â”‚                                  â”‚
â”‚    â”‚ ã€Œé€šçŸ¥ã‚’ãŠãï¼ã€                  â”‚                                  â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  POST /webhook                   â”‚
â”‚    â”‚     Body: {"event": "..."}  â”‚                                  â”‚
â”‚    â”‚                              â”‚  å‡¦ç†å®Ÿè¡Œ                         â”‚
â”‚    â”‚                              â”‚                                  â”‚
â”‚  â€» ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã«å³åº§ã«é€šçŸ¥                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸€èˆ¬çš„ãª Webhook ãƒ•ãƒ­ãƒ¼

1. **Webhook URL ç™»éŒ²**: å—ä¿¡å´ãŒ Webhook URL ã‚’é€šçŸ¥å…ƒã«ç™»éŒ²
2. **ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ**: é€šçŸ¥å…ƒã§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
3. **HTTP POST é€ä¿¡**: é€šçŸ¥å…ƒãŒ Webhook URL ã¸ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
4. **å‡¦ç†å®Ÿè¡Œ**: å—ä¿¡å´ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†
5. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´**: å—ä¿¡å´ãŒ `2xx` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿”ã™

---

## ãƒ‘ãƒ¼ãƒˆ2: EgoGraph ã§ã®ä½¿ç”¨

### ä½¿ç”¨ç›®çš„

- **ã‚¿ã‚¹ã‚¯å®Œäº†é€šçŸ¥**: tmux ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‡¦ç†å®Œäº†ã‚’ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
- **ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡**: ä»»æ„ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã«é€šçŸ¥

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
POST /v1/push/webhook
```

### èªè¨¼

`X-Webhook-Secret` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆèªè¨¼ï¼š

```bash
curl -X POST http://gateway:8001/v1/push/webhook \
  -H "X-Webhook-Secret: your-secret-key" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "task_completed",
    "session_id": "agent-0001",
    "title": "å®Œäº†",
    "body": "ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
  }'
```

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ |
|----------|------|------|------|
| `type` | string | âœ“ | ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: `task_completed`, `chat_completed`ï¼‰ |
| `session_id` | string | âœ“ | ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆä¾‹: `agent-0001`ï¼‰ |
| `title` | string | âœ“ | é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ1-100æ–‡å­—ï¼‰ |
| `body` | string | âœ“ | é€šçŸ¥æœ¬æ–‡ï¼ˆ1-500æ–‡å­—ï¼‰ |

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

æˆåŠŸæ™‚ï¼ˆ200 OKï¼‰ï¼š

```json
{
  "success_count": 1,
  "failure_count": 0,
  "invalid_tokens": []
}
```

### FCM ãƒˆãƒ¼ã‚¯ãƒ³ç™»éŒ²

é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€äº‹å‰ã«ãƒ‡ãƒã‚¤ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```bash
curl -X PUT http://gateway:8001/v1/push/token \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "device_token": "firebase-device-token",
    "platform": "android",
    "device_name": "My Phone"
  }'
```

### é€šçŸ¥ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EgoGraph Webhook é€šçŸ¥ãƒ•ãƒ­ãƒ¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  [å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹]         [Gateway]                  [Firebase]            â”‚
â”‚  (Agentç­‰)           (Webhookå—ä¿¡+FCMé€ä¿¡)        (FCMã‚µãƒ¼ãƒ“ã‚¹)          â”‚
â”‚       â”‚                      â”‚                            â”‚             â”‚
â”‚       â”‚ â‘  ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ         â”‚                            â”‚             â”‚
â”‚       â”‚                      â”‚                            â”‚             â”‚
â”‚       â”‚ â‘¡ POST /v1/push/webhook                       â”‚             â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                            â”‚             â”‚
â”‚       â”‚   X-Webhook-Secret   â”‚                            â”‚             â”‚
â”‚       â”‚                      â”‚                            â”‚             â”‚
â”‚       â”‚                  â‘¢ èªè¨¼æ¤œè¨¼                       â”‚             â”‚
â”‚       â”‚                  â‘£ ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼                   â”‚             â”‚
â”‚       â”‚                  â‘¤ FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—                â”‚             â”‚
â”‚       â”‚                      â”‚                            â”‚             â”‚
â”‚       â”‚                  â‘¥ FCMé€ä¿¡                      â”‚             â”‚
â”‚       â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚
â”‚       â”‚                      â”‚                            â”‚             â”‚
â”‚       â”‚                      â”‚                        â‘¦ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥     â”‚
â”‚       â”‚                      â”‚                            â”œâ”€â”€â”€â†’ [ãƒ¦ãƒ¼ã‚¶ãƒ¼ç«¯æœ«]
â”‚       â”‚                      â”‚                            â”‚             â”‚
â”‚       â”‚  â‘§ ãƒ¬ã‚¹ãƒãƒ³ã‚¹         â”‚                            â”‚             â”‚
â”‚       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‘ãƒ¼ãƒˆ3: å®Ÿè£…ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

### ã‚±ãƒ¼ã‚¹1: Claude Code ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†é€šçŸ¥

Claude Code ã® Stop Hook ã‹ã‚‰ Webhook ã‚’é€ä¿¡ï¼š

```python
# /root/.claude/hooks/send-webhook-on-stop.py
import httpx
import os

async def send_webhook():
    await httpx.post(
        "http://localhost:8001/v1/push/webhook",
        headers={"X-Webhook-Secret": os.getenv("GATEWAY_WEBHOOK_SECRET")},
        json={
            "type": "claude_session_stopped",
            "session_id": "claude-code",
            "title": "Claude Code å®Œäº†",
            "body": "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸ"
        }
    )
```

`~/.claude/settings.json` ã«è¨­å®šï¼š

```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 /root/.claude/hooks/send-webhook-on-stop.py"
          }
        ]
      }
    ]
  }
}
```

### ã‚±ãƒ¼ã‚¹2: ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Œäº†å¾Œã«é€šçŸ¥ã‚’é€ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼ï¼š

```bash
#!/bin/bash
# agent-run ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

SESSION_NAME="agent-$(date +%Y%m%d-%H%M%S)"

# tmux ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•
tmux new-session -d -s "$SESSION_NAME" "$@"

# ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†å¾…æ©Ÿ
while tmux has-session -t "$SESSION_NAME" 2>/dev/null; do
    sleep 1
done

# å®Œäº†é€šçŸ¥
python -m gateway.cli \
  --secret "$GATEWAY_WEBHOOK_SECRET" \
  --session "$SESSION_NAME" \
  --title "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Œäº†" \
  --body "ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
```

### ã‚±ãƒ¼ã‚¹3: å°‚ç”¨é€šçŸ¥ã‚³ãƒãƒ³ãƒ‰

```python
# gateway/cli.py
import asyncio
import httpx

async def send_webhook(
    webhook_url: str,
    webhook_secret: str,
    event_type: str,
    session_id: str,
    title: str,
    body: str,
) -> None:
    payload = {
        "type": event_type,
        "session_id": session_id,
        "title": title,
        "body": body,
    }

    async with httpx.AsyncClient() as client:
        response = await client.post(
            webhook_url,
            json=payload,
            headers={
                "X-Webhook-Secret": webhook_secret,
                "Content-Type": "application/json",
            },
            timeout=10.0,
        )
        response.raise_for_status()
```

ä½¿ç”¨ä¾‹ï¼š

```bash
python -m gateway.cli \
  --secret "$GATEWAY_WEBHOOK_SECRET" \
  --session "agent-0001" \
  --title "ãƒãƒƒãƒå®Œäº†" \
  --body "ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ"
```

---

## ãƒ‘ãƒ¼ãƒˆ4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### å®Ÿæ–½æ¸ˆã¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

| å¯¾ç­– | çŠ¶æ…‹ | è©•ä¾¡ |
|-----|------|------|
| Webhook Secret èªè¨¼ | âœ… å®Ÿè£…æ¸ˆã¿ | â­â­â­â­â­ |
| Timing Attack å¯¾ç­– | âœ… `secrets.compare_digest()` | â­â­â­â­â­ |
| Pydantic å…¥åŠ›æ¤œè¨¼ | âœ… å®Ÿè£…æ¸ˆã¿ | â­â­â­â­â­ |

### Webhook ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å¯¾ç­– | å®Ÿè£…çŠ¶æ³ |
|--------|------|---------|
| èªè¨¼ãªã— | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆèªè¨¼ | âœ… å®Ÿè£…æ¸ˆã¿ |
| å¼±ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | 32ãƒã‚¤ãƒˆä»¥ä¸Šã®ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ— | âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–æ¸ˆã¿ |
| Timing Attack | `secrets.compare_digest()` | âœ… å®Ÿè£…æ¸ˆã¿ |
| ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒ | ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ | âš ï¸ æœªå®Ÿè£… |
| DoS æ”»æ’ƒ | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | âš ï¸ æœªå®Ÿè£… |
| ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ | å…¥åŠ›å€¤æ¤œè¨¼ | âœ… å®Ÿè£…æ¸ˆã¿ |

### Timing Attack å¯¾ç­–

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¯”è¼ƒã«ã¯å¿…ãš `secrets.compare_digest()` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```python
# gateway/dependencies.py
import secrets

if not secrets.compare_digest(webhook_secret, expected_secret):
    raise HTTPException(status_code=401, detail="Invalid webhook secret")
```

**ãªãœ `==` ã§ã¯ãƒ€ãƒ¡ãªã®ã‹ï¼Ÿ**

`==` æ¼”ç®—å­ã¯å…ˆé ­ã‹ã‚‰1æ–‡å­—ãšã¤æ¯”è¼ƒã™ã‚‹ãŸã‚ã€å‡¦ç†æ™‚é–“ã®å·®ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¨æ¸¬ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆTiming Attackï¼‰ã€‚`compare_digest()` ã¯å¸¸ã«ä¸€å®šæ™‚é–“ã§æ¯”è¼ƒã—ã¾ã™ã€‚

### ğŸŸ¡ å„ªå…ˆåº¦ä¸­: ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒå¯¾ç­–

**ç¾çŠ¶**: Webhook ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ãªã—
**ãƒªã‚¹ã‚¯**: åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†é€ã«ã‚ˆã‚ŠäºŒé‡å‡¦ç†

**æ¨å¥¨å¯¾ç­–**: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ã®è¿½åŠ 

```python
class WebhookPayload(BaseModel):
    timestamp: int  # Unix ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
    type: str
    session_id: str
    title: str
    body: str

# æ¤œè¨¼ï¼ˆè¨±å®¹å·®5åˆ†ï¼‰
if abs(time.time() - payload.timestamp) > 300:
    raise HTTPException(status_code=400, detail="Expired timestamp")
```

### ğŸŸ¡ å„ªå…ˆåº¦ä¸­: ãƒ¬ãƒ¼ãƒˆåˆ¶é™

**æ¨å¥¨å¯¾ç­–**: slowapi ç­‰ã‚’ä½¿ç”¨ã—ãŸãƒ¬ãƒ¼ãƒˆåˆ¶é™

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/v1/push/webhook")
@limiter.limit("10/minute")  # 1åˆ†é–“ã«10å›
async def send_webhook(...):
    ...
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡ã‚µãƒãƒªãƒ¼

```
èªè¨¼ãƒ»èªå¯         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  90%  â­â­â­â­â­
å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  90%  â­â­â­â­â­
ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒå¯¾ç­–    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  20%  â­â­
DoS å¯¾ç­–          â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  20%  â­â­

Webhookå…¨ä½“       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘  80%  â­â­â­â­
```

### æ¨å¥¨æœ¬ç•ªæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ HTTPS (443)
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              [ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·]                              â”‚
â”‚  â€¢ Nginx / Caddy / Traefik                                  â”‚
â”‚  â€¢ TLS çµ‚ç«¯å‡¦ç†                                               â”‚
â”‚  â€¢ ãƒ¬ãƒ¼ãƒˆåˆ¶é™                                                â”‚
â”‚  â€¢ IP ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ HTTP (8080)
                          â†“  (å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ - å¹³æ–‡ã§å¯)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Gateway (:8001)                           â”‚
â”‚  â€¢ Webhook èªè¨¼                                             â”‚
â”‚  â€¢ FCM é€ä¿¡                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Firebase FCM                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‘ãƒ¼ãƒˆ5: ç’°å¢ƒè¨­å®š

### ç’°å¢ƒå¤‰æ•°è¨­å®š

`.env` ã§è¨­å®šã™ã‚‹é …ç›®ï¼š

| ç’°å¢ƒå¤‰æ•° | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|------|----------|------|
| `GATEWAY_WEBHOOK_SECRET` | âœ“ | - | Webhook ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆ32ãƒã‚¤ãƒˆä»¥ä¸Šæ¨å¥¨ï¼‰ |
| `GCM_PROJECT_ID` | - | - | Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID |
| `FCM_CREDENTIALS_PATH` | - | - | Firebase ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®ãƒ‘ã‚¹ |

### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç”Ÿæˆ

```bash
# 32ãƒã‚¤ãƒˆä»¥ä¸Šã®ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
openssl rand -base64 32
```

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `gateway/api/push.py` - Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- `gateway/services/fcm_service.py` - FCM ã‚µãƒ¼ãƒ“ã‚¹
- `gateway/domain/models.py` - ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®šç¾©
- `gateway/dependencies.py` - èªè¨¼å‡¦ç†

## å‚è€ƒè³‡æ–™

- [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)
- [OWASP Webhook Security Guidelines](https://github.com/OWASP/GitHub-Security-Whitepaper)
- [Webhook Best Practices](https://sendgrid.com/blog/webhooks-vs-api-the-difference/)
