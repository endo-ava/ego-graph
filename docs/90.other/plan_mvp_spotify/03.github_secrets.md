# GitHub Secrets 設定ガイド

このガイドでは、取得したAPIクレデンシャルをGitHub Secretsに安全に保存する方法を説明します。

## GitHub Secrets とは？

GitHub Secretsは、APIキーやパスワードなどの機密情報を暗号化して保存する機能です。GitHub Actionsのワークフロー内で安全に使用できます。

### セキュリティ機能
- 保存時に自動的に暗号化
- ログに表示されない（`***`でマスク）
- リポジトリの管理者のみがアクセス可能

## 前提条件

- [02.api_keys.md](./02.api_keys.md) で全てのAPIクレデンシャルを取得済み
- GitHubリポジトリへの管理者権限

## 設定手順

### ステップ1: リポジトリのSecretsページにアクセス

1. GitHubでEgoGraphリポジトリを開く
2. 上部メニューから「**Settings**」タブをクリック
3. 左サイドバーの「**Secrets and variables**」セクションを展開
4. 「**Actions**」をクリック

### ステップ2: Secretsを追加

以下の6つのSecretを1つずつ追加します。

#### Secret 1: SPOTIFY_CLIENT_ID

1. 「**New repository secret**」ボタンをクリック
2. Name欄に `SPOTIFY_CLIENT_ID` と入力（大文字小文字を正確に）
3. Secret欄にSpotify Developer Dashboardから取得したClient IDを貼り付け
4. 「**Add secret**」をクリック

#### Secret 2: SPOTIFY_CLIENT_SECRET

1. 「**New repository secret**」ボタンをクリック
2. Name欄に `SPOTIFY_CLIENT_SECRET` と入力
3. Secret欄にSpotify Developer Dashboardから取得したClient Secretを貼り付け
4. 「**Add secret**」をクリック

#### Secret 3: SPOTIFY_REFRESH_TOKEN

1. 「**New repository secret**」ボタンをクリック
2. Name欄に `SPOTIFY_REFRESH_TOKEN` と入力
3. Secret欄にOAuth認証で取得したRefresh Tokenを貼り付け
4. 「**Add secret**」をクリック

#### Secret 4: NOMIC_API_KEY

1. 「**New repository secret**」ボタンをクリック
2. Name欄に `NOMIC_API_KEY` と入力
3. Secret欄にNomic Atlasから取得したAPI Keyを貼り付け
4. 「**Add secret**」をクリック

#### Secret 5: QDRANT_URL

1. 「**New repository secret**」ボタンをクリック
2. Name欄に `QDRANT_URL` と入力
3. Secret欄にQdrant CloudのCluster URL全体を貼り付け
   - 例: `https://abc123.us-east-1-0.aws.cloud.qdrant.io`
   - 末尾のスラッシュ（`/`）は不要
4. 「**Add secret**」をクリック

#### Secret 6: QDRANT_API_KEY

1. 「**New repository secret**」ボタンをクリック
2. Name欄に `QDRANT_API_KEY` と入力
3. Secret欄にQdrant CloudのAPI Keyを貼り付け
4. 「**Add secret**」をクリック

### ステップ3: 設定確認

Secretsページに以下の6つが表示されていることを確認：

```
NOMIC_API_KEY
QDRANT_API_KEY
QDRANT_URL
SPOTIFY_CLIENT_ID
SPOTIFY_CLIENT_SECRET
SPOTIFY_REFRESH_TOKEN
```

（アルファベット順に表示されます）

## よくある間違い

### 1. Secret名のタイプミス
❌ `SPOTIFY_CLIENTID` （アンダースコア忘れ）
❌ `spotify_client_id` （小文字）
❌ `SPOTIFY CLIENT ID` （スペース）
✅ `SPOTIFY_CLIENT_ID` （正しい）

**重要**: Secret名は大文字小文字を区別し、GitHub Actionsのワークフローファイルと完全に一致する必要があります。

### 2. 値の前後に空白が入っている
コピー&ペースト時に誤って空白が入ることがあります。
```
❌ " abc123xyz " （前後に空白）
✅ "abc123xyz" （正しい）
```

### 3. URLの形式ミス
```
❌ https://abc123.us-east-1-0.aws.cloud.qdrant.io/ （末尾のスラッシュ）
✅ https://abc123.us-east-1-0.aws.cloud.qdrant.io （正しい）
```

## Secretsの更新方法

Secretの値を変更する場合：

1. Secretsページで変更したいSecretの右側の「**Update**」をクリック
2. 新しい値を入力
3. 「**Update secret**」をクリック

**注意**: 古い値は確認できないため、新しい値を用意してから更新してください。

## Secretsの削除方法

Secretを削除する場合（注意して実行）：

1. Secretsページで削除したいSecretの右側の「**Remove**」をクリック
2. 確認ダイアログで「**Yes, remove this secret**」をクリック

## GitHub Actionsでの使用方法

設定したSecretsは、ワークフローファイル（`.github/workflows/spotify_ingest.yml`）で以下のように参照されます：

```yaml
env:
  SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
  SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
  SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
  NOMIC_API_KEY: ${{ secrets.NOMIC_API_KEY }}
  QDRANT_URL: ${{ secrets.QDRANT_URL }}
  QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
```

Pythonコード内では環境変数として取得：

```python
import os

spotify_client_id = os.getenv("SPOTIFY_CLIENT_ID")
```

## セキュリティベストプラクティス

### やるべきこと ✅
- GitHub Secretsのみを使用してクレデンシャルを管理
- 定期的にAPIキーをローテーション（3-6ヶ月ごと）
- 不要になったSecretsは削除
- リポジトリのアクセス権限を最小限に

### やってはいけないこと ❌
- Secretsの値をコードやコメントに記載
- `.env`ファイルをGitにコミット
- Secretsの値をログに出力
- パブリックリポジトリでSecretsを使用（フォーク経由で漏洩の可能性）

## トラブルシューティング

### エラー: "Secret not found"

**原因**: Secret名がワークフローファイルと一致していない

**解決策**:
1. Secretsページで名前を確認（大文字小文字を含む完全一致が必要）
2. ワークフローファイル（`.github/workflows/spotify_ingest.yml`）の`secrets.SECRET_NAME`と比較
3. 名前が違う場合は、Secretを削除して正しい名前で再作成

### エラー: 認証失敗（401 Unauthorized）

**原因**: Secret の値が間違っているか期限切れ

**解決策**:
1. 該当するAPIのダッシュボードで値を再確認
2. 特にSpotify Refresh Tokenは再取得が必要な場合あり
3. Secretを更新

### ワークフローが実行されない

**原因**: GitHub Actionsが無効になっている可能性

**解決策**:
1. リポジトリの「**Actions**」タブを開く
2. 「I understand my workflows, go ahead and enable them」をクリック
3. ワークフローを手動で実行してテスト

## 次のステップ

GitHub Secretsの設定が完了したら、実際にパイプラインを動かしてみましょう：

1. リポジトリの「**Actions**」タブを開く
2. 左サイドバーから「Spotify Data Ingestion」ワークフローを選択
3. 「**Run workflow**」→「**Run workflow**」で手動実行
4. 数分後、ワークフローが成功（緑のチェックマーク✅）することを確認

問題が発生した場合は [04.troubleshooting.md](./04.troubleshooting.md) を参照してください。

## チェックリスト

設定完了の確認：

```
□ SPOTIFY_CLIENT_ID を追加した
□ SPOTIFY_CLIENT_SECRET を追加した
□ SPOTIFY_REFRESH_TOKEN を追加した
□ NOMIC_API_KEY を追加した
□ QDRANT_URL を追加した（末尾のスラッシュなし）
□ QDRANT_API_KEY を追加した
□ Secretsページで6つ全て表示されることを確認した
□ Secret名にタイプミスがないことを確認した
```

全てチェックが付いたら、次は実際にワークフローを実行してみましょう！
