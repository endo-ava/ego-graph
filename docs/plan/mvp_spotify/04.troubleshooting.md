# トラブルシューティングガイド

EgoGraph Spotify MVPで発生する可能性のある一般的な問題と解決方法をまとめたガイドです。

## 目次
1. [GitHub Actions関連](#github-actions関連)
2. [Spotify API関連](#spotify-api関連)
3. [Nomic API関連](#nomic-api関連)
4. [Qdrant関連](#qdrant関連)
5. [Python/依存関係関連](#python依存関係関連)
6. [その他](#その他)

---

## GitHub Actions関連

### 問題: ワークフローが実行されない

**症状**:
- Actionsタブにワークフローが表示されない
- 手動実行ボタンが表示されない

**原因**:
- GitHub Actionsが無効になっている
- ワークフローファイルの構文エラー

**解決策**:
1. リポジトリの「Actions」タブを開く
2. 黄色のバナーが表示されている場合、「I understand my workflows, go ahead and enable them」をクリック
3. ワークフローファイル（`.github/workflows/spotify_ingest.yml`）のYAML構文を確認
4. オンラインのYAML Validatorで構文チェック

### 問題: ワークフローが失敗する（赤いX印）

**症状**:
- ワークフロー実行が失敗
- エラーメッセージが表示される

**解決策**:
1. Actionsタブで失敗したワークフローをクリック
2. 失敗したジョブをクリック
3. ログを展開してエラーメッセージを確認
4. エラーの種類に応じて以下のセクションを参照

### 問題: "Secret not found" エラー

**症状**:
```
Error: The secret 'SPOTIFY_CLIENT_ID' was not found
```

**原因**:
- Secret名がワークフローと一致していない
- Secretが設定されていない

**解決策**:
1. Settings → Secrets and variables → Actions で全てのSecretsが設定されているか確認
2. Secret名が大文字小文字含めて完全一致しているか確認
3. [03.github_secrets.md](./03.github_secrets.md) を参照して再設定

---

## Spotify API関連

### 問題: 401 Unauthorized エラー

**症状**:
```
HTTP Error 401: Unauthorized
または
SpotifyException: Invalid access token
```

**原因**:
- Client IDまたはClient Secretが間違っている
- Refresh Tokenが期限切れまたは無効

**解決策**:

#### ステップ1: Client IDとSecretを確認
1. https://developer.spotify.com/dashboard でアプリを開く
2. Settingsで正しいClient IDとSecretを確認
3. GitHub Secretsの値と一致するか確認
4. 違う場合はSecretsを更新

#### ステップ2: Refresh Tokenを再取得
1. [02.api_keys.md](./02.api_keys.md) のステップ3を再実行
2. 新しいRefresh Tokenを取得
3. GitHub Secretsの`SPOTIFY_REFRESH_TOKEN`を更新

### 問題: 429 Too Many Requests エラー

**症状**:
```
HTTP Error 429: Too Many Requests
Retry-After: 30
```

**原因**:
- Spotify APIのレート制限超過（180 req/min）

**解決策**:
- 通常は自動的にリトライされます（エクスポネンシャルバックオフ）
- 頻繁に発生する場合は、ワークフローの実行頻度を減らす（cronの間隔を広げる）

### 問題: Redirect URI mismatch エラー

**症状**:
```
Redirect URI mismatch
```

**原因**:
- Spotify Developer Dashboardで設定したRedirect URIが`http://localhost:8888/callback`と一致していない

**解決策**:
1. https://developer.spotify.com/dashboard でアプリを開く
2. Settings → Redirect URIs
3. `http://localhost:8888/callback` が正確に登録されているか確認
4. 登録されていない場合は追加してSave

### 問題: Insufficient scope エラー

**症状**:
```
Insufficient client scope
```

**原因**:
- 必要なOAuthスコープでRefresh Tokenを取得していない

**解決策**:
1. [02.api_keys.md](./02.api_keys.md) のステップ3を再実行
2. 以下のスコープが含まれることを確認：
   - `user-read-recently-played`
   - `playlist-read-private`
   - `playlist-read-collaborative`

---

## Nomic API関連

### 問題: 401 Unauthorized エラー

**症状**:
```
HTTP Error 401: Unauthorized
または
Invalid API key
```

**原因**:
- API Keyが間違っている
- API Keyが無効化された

**解決策**:
1. https://atlas.nomic.ai にログイン
2. Settings → API Keys でキーを確認
3. 必要に応じて新しいキーを生成
4. GitHub Secretsの`NOMIC_API_KEY`を更新

### 問題: 429 Rate Limit エラー

**症状**:
```
HTTP Error 429: Rate limit exceeded
```

**原因**:
- Nomic APIのレート制限超過（100 req/min）

**解決策**:
- パイプラインのバッチサイズが適切に設定されていれば通常発生しません
- 頻繁に発生する場合は、バッチサイズを増やす（100テキスト/リクエスト推奨）

### 問題: Quota exceeded エラー

**症状**:
```
Monthly quota exceeded
```

**原因**:
- 月間100万埋め込みの無料枠を超過

**解決策**:
1. https://atlas.nomic.ai のダッシュボードで使用量を確認
2. 不要なデータの削除または有料プランへのアップグレードを検討
3. MVP範囲では通常発生しないはず（月1,500埋め込み程度）

---

## Qdrant関連

### 問題: 接続エラー

**症状**:
```
Connection refused
または
Failed to connect to Qdrant
```

**原因**:
- Qdrant URLが間違っている
- API Keyが間違っている
- クラスタが停止している

**解決策**:

#### ステップ1: クラスタの状態を確認
1. https://cloud.qdrant.io にログイン
2. クラスタの状態が「Running」になっているか確認
3. 停止している場合は「Start」をクリック

#### ステップ2: URLとAPI Keyを確認
1. クラスタの詳細ページでCluster URLを確認
2. 正しい形式: `https://abc123.us-east-1-0.aws.cloud.qdrant.io`
3. 末尾のスラッシュ（`/`）がないことを確認
4. API Keys タブでキーを確認
5. GitHub Secretsの値と一致するか確認

### 問題: 認証エラー（403 Forbidden）

**症状**:
```
HTTP Error 403: Forbidden
または
Authentication failed
```

**原因**:
- API Keyが間違っている
- API Keyが無効化された

**解決策**:
1. Qdrant CloudのクラスタページでAPI Keyを確認
2. 必要に応じて新しいキーを生成
3. GitHub Secretsの`QDRANT_API_KEY`を更新

### 問題: ストレージ容量不足

**症状**:
```
Storage limit exceeded
```

**原因**:
- 無料枠の1GBを超過

**解決策**:
1. Qdrantダッシュボードでストレージ使用量を確認
2. 古いデータを削除またはコレクションをクリア
3. 有料プランへのアップグレードを検討
4. **注**: MVP範囲では通常発生しない（年間18MB程度）

---

## Python/依存関係関連

### 問題: ModuleNotFoundError

**症状**:
```
ModuleNotFoundError: No module named 'spotipy'
```

**原因**:
- 依存関係がインストールされていない

**解決策**:
1. ワークフローファイルで`pip install`ステップが正しく実行されているか確認
2. `requirements.txt`ファイルが正しい場所にあるか確認
3. ローカルでテストする場合：
```bash
pip install -r requirements.txt
pip install -r src/ingest/requirements.txt
pip install -r src/pipeline/requirements.txt
```

### 問題: Import Error（循環参照）

**症状**:
```
ImportError: cannot import name 'X' from partially initialized module
```

**原因**:
- 循環インポートの問題
- `__init__.py`ファイルの問題

**解決策**:
1. インポート順序を確認
2. 相対インポートを絶対インポートに変更
3. `__init__.py`ファイルが各ディレクトリに存在するか確認

### 問題: バージョン互換性エラー

**症状**:
```
ERROR: Package 'llama-index' requires a different Python version
```

**原因**:
- Python バージョンの不一致

**解決策**:
1. ワークフローファイルで Python 3.11 が指定されているか確認
2. ローカル環境の場合:
```bash
python --version  # 3.11以上を確認
```

---

## その他

### 問題: パイプラインが遅い

**症状**:
- ワークフローの実行に10分以上かかる

**原因**:
- 処理するデータ量が多い
- API呼び出しが非効率

**解決策**:
1. ログで各ステップの所要時間を確認
2. 特定のステップが遅い場合：
   - Spotify API: プレイリスト数を減らす
   - Nomic API: バッチサイズを増やす（最大100）
   - Qdrant: アップサートのバッチサイズを増やす（最大1000）

### 問題: データが重複している

**症状**:
- 同じ曲が複数回保存される

**原因**:
- 重複排除ロジックが未実装（MVP範囲外）

**解決策**:
- MVP段階では許容（後のフェーズで重複排除機能を実装予定）
- 気になる場合は、Qdrantのコレクションを削除して再作成：
```python
from qdrant_client import QdrantClient

client = QdrantClient(url="YOUR_URL", api_key="YOUR_KEY")
client.delete_collection("egograph_spotify")
```

### 問題: ログが見つからない

**症状**:
- GitHub Actionsのログが表示されない

**解決策**:
1. ワークフローの実行履歴は90日間保持されます
2. 古い実行のログは削除されている可能性があります
3. 重要なログはArtifactsとして保存（失敗時のみ、7日間保持）

---

## デバッグのヒント

### ローカルでテストする方法

GitHub Actionsで問題が発生した場合、ローカルで再現してデバッグできます：

1. `.env`ファイルを作成（`.env.example`をコピー）
2. 全てのクレデンシャルを`.env`に記入
3. Pythonスクリプトを直接実行：
```bash
python src/main.py
```

**注意**: `.env`ファイルは絶対にGitにコミットしないでください！

### ログレベルの調整

より詳細なログを出力する場合、環境変数を設定：

```python
import logging
logging.basicConfig(level=logging.DEBUG)  # DEBUGレベルに変更
```

### APIレスポンスの確認

問題を特定するため、APIレスポンスをログに出力：

```python
import logging
logger = logging.getLogger(__name__)

response = requests.get(url, headers=headers)
logger.debug(f"Status: {response.status_code}")
logger.debug(f"Response: {response.text[:500]}")  # 最初の500文字
```

---

## よくある質問 (FAQ)

### Q: Refresh Tokenはどのくらいの頻度で更新が必要？
A: Spotifyのリフレッシュトークンは基本的に永続的ですが、以下の場合は再取得が必要：
- ユーザーがSpotifyアカウントのパスワードを変更
- ユーザーがアプリの認証を取り消し
- 長期間（1年以上）使用していない

### Q: ワークフローの実行時刻を変更できる？
A: はい。`.github/workflows/spotify_ingest.yml`の`cron`行を編集：
```yaml
- cron: '0 2 * * *'  # 毎日02:00 UTC
```
時刻はUTCで指定します（日本時間 = UTC + 9時間）

### Q: 手動でワークフローを実行するには？
A:
1. リポジトリの「Actions」タブを開く
2. 左サイドバーから「Spotify Data Ingestion」を選択
3. 「Run workflow」ボタンをクリック
4. 「Run workflow」を再度クリック

### Q: 無料枠を超えたらどうなる？
A:
- **Nomic**: APIリクエストがエラーを返します（有料プランへのアップグレードが必要）
- **Qdrant**: データの追加ができなくなります（古いデータの削除または有料プランへのアップグレードが必要）
- **GitHub Actions**: ワークフローが実行されなくなります（翌月まで待つか、有料プランへのアップグレード）

---

## サポートリソース

### 公式ドキュメント
- [Spotify Web API](https://developer.spotify.com/documentation/web-api/)
- [Nomic Atlas](https://docs.nomic.ai/)
- [Qdrant Documentation](https://qdrant.tech/documentation/)
- [GitHub Actions](https://docs.github.com/en/actions)

### コミュニティ
- [Spotify Developer Forum](https://community.spotify.com/t5/Spotify-for-Developers/bd-p/Spotify_Developer)
- [Qdrant Discord](https://qdrant.to/discord)

---

## 問題が解決しない場合

上記で解決しない場合：

1. **ログの確認**: GitHub Actionsの完全なログを確認
2. **エラーメッセージの検索**: エラーメッセージをGoogle検索
3. **Issue作成**: GitHubリポジトリでIssueを作成
   - エラーメッセージの全文を含める
   - 再現手順を詳しく記載
   - 環境情報（Python バージョン、OS等）を含める

**注意**: Issueにはクレデンシャル（API Key、トークン等）を絶対に含めないでください！
