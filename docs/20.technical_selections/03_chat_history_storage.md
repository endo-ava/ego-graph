# 技術選定レポート: チャット履歴の永続化

## 1. 概要
EgoGraphのチャットUIで生成される会話履歴を、**BackendサーバーのローカルにDuckDBファイルとして永続保存する**方針を採用する。
R2上のParquetは分析・集計用途に最適化されたストレージであり、UI向けの即時参照には不向きなため、履歴はOLTP寄りのストアに分離する。

## 2. 背景と要件
* 現状はR2上のParquetをDuckDBで直接読み込む構成で、**セッションをクリアすると会話が残らない**。
* ChatGPTのように**スレッド一覧から会話へ戻れる体験**が必要。
* 個人用途・ローカルファーストを前提に、**低運用コスト**と**即時レスポンス**を重視する。
* 将来的に複数ユーザー化する可能性はあるが、現時点では単一ユーザー前提。

## 3. 候補比較

| 選択肢 | メリット | デメリット | 適用性 |
|---|---|---|---|
| **DuckDB（ローカルファイル）** | 既存資産を活用、導入が最小、Parquetと相性良い | 同時書き込みに弱い、OLTP用途は限定的 | **個人用途に最適** |
| SQLite（ローカルファイル） | 軽量、OLTP実績が豊富 | DuckDB資産の再利用が弱い | 個人用途には適合 |
| R2/Parquetのみ | 分析には強い | 低レイテンシCRUDに不向き、更新が重い | UI用途には不適 |
| Postgres | マルチユーザーで強い、標準的 | 導入・運用コスト増 | 複数ユーザー化で有力 |

## 4. 採用理由（DuckDBローカル保存）
1. **既存資産の活用**: DuckDBの導入・運用ノウハウが既にある。
2. **導入コスト最小**: 新しいDBサーバー運用が不要で、ファイル配置だけで開始できる。
3. **ローカルファーストに合致**: UIのレスポンスが即時で、オフラインでも動作。
4. **分析との親和性**: 将来的に履歴をParquetへアーカイブしやすい。

## 5. 実装方針（概要）
* DB配置: Backendサーバー上のローカルファイル（例: `backend/data/chat.duckdb`）
* データ構造: `threads` と `messages` の2階層
* 主要インデックス: `thread_id`, `created_at`, `last_message_at`
* セッションクリアは「新規スレッド作成」に置き換える

## 6. 将来の複数ユーザー化への備え
* すべてのテーブルに `user_id` を含める（将来移行のための最低限の準備）
* 同時アクセスが増えた段階で **Postgresへ移行**するのが一般的
* DuckDBは個人・単一プロセス用途の範囲で最適

## 7. 結論
EgoGraphの現状（個人用途・ローカルファースト・既存DuckDB資産）を踏まえると、
**チャット履歴はBEサーバーのローカルDuckDBファイルに保存するのが最適**である。
複数ユーザー化が現実になった時点で、PostgresなどのOLTP専用DBに移行する方針とする。
