● User approved Claude's plan
  ⎿  Plan saved to: ~/.claude/plans/wobbly-foraging-candle.md · /plan to edit
     EgoGraph Spotify MVP 実装プラン

     概要

     EgoGraphのSpotify統合MVPを実装します。データパイプライン（収集 + 保存 + 
     埋め込み生成）に焦点を当て、RAGクエリ機能やフロントエンドは後回しにします。

     スコープ

     - 含む: Spotifyデータ収集、LlamaIndex処理、Nomic埋め込み生成、Qdrant保存、GitHub Actions自動化
     - 含まない: FastAPI RAGエンドポイント、Next.jsフロントエンド（後のフェーズ）

     技術スタック

     - データ収集: Python + Spotipy
     - ETL処理: LlamaIndex
     - 埋め込み: Nomic API
     - ベクトルDB: Qdrant Cloud（無料枠）
     - オーケストレーション: GitHub Actions（毎日02:00 UTC実行）

     ディレクトリ構造

     /home/ryuto/ego-graph/
     ├── .github/workflows/
     │   └── spotify_ingest.yml          # 日次自動実行ワークフロー
     ├── src/
     │   ├── shared/
     │   │   ├── models.py               # 統一スキーマ（Pydanticモデル）
     │   │   ├── config.py               # 設定管理
     │   │   └── utils.py                # 共通ユーティリティ
     │   ├── ingest/spotify/
     │   │   ├── collector.py            # Spotify API連携
     │   │   ├── transformer.py          # 統一スキーマへの変換
     │   │   └── config.py               # Spotify固有設定
     │   ├── pipeline/
     │   │   ├── etl.py                  # LlamaIndex ETLパイプライン
     │   │   ├── embeddings.py           # Nomic API統合
     │   │   └── storage.py              # Qdrant Cloud統合
     │   └── main.py                     # エントリーポイント
     ├── tests/                          # ユニット＆統合テスト
     ├── docs/plan/                      # ユーザー向けセットアップガイド
     │   ├── 01.user_setup.md
     │   ├── 02.api_keys.md
     │   ├── 03.github_secrets.md
     │   └── 04.troubleshooting.md
     ├── requirements.txt
     └── README.md

     実装順序

     フェーズ1: 基盤構築（優先度：最高）

     ファイル:
     - src/shared/models.py - 統一データモデル（Pydantic）
     - src/shared/config.py - 環境変数管理
     - .gitignore, .env.example, README.md

     統一スキーマ:
     class UnifiedDataModel(BaseModel):
         id: UUID
         source: DataSource  # "spotify"
         type: DataType      # "music"
         timestamp: datetime
         raw_text: str       # 検索用テキスト
         metadata: Dict[str, Any]  # Spotify固有データ
         embedding: Optional[List[float]]
         sensitivity: SensitivityLevel  # "low"|"medium"|"high"
         nsfw: bool

     フェーズ2: Spotifyデータ収集（優先度：最高）

     ファイル:
     - src/ingest/spotify/collector.py - Spotify Web API連携
     - src/ingest/spotify/transformer.py - 統一スキーマへの変換

     収集データ:
     1. 最近再生した曲（listening history）
       - エンドポイント: GET /v1/me/player/recently-played
       - 最大50曲（API制限）
     2. ユーザープレイリスト
       - エンドポイント: GET /v1/me/playlists
       - 各プレイリストのトラックリスト

     OAuth 2.0認証:
     - クライアントクレデンシャル + リフレッシュトークン
     - Spotipy ライブラリを使用
     - 必要なスコープ: user-read-recently-played, playlist-read-private, playlist-read-collaborative

     フェーズ3: ETLパイプライン（優先度：最高）

     ファイル:
     - src/pipeline/etl.py - LlamaIndex統合
     - src/pipeline/embeddings.py - Nomic API連携
     - src/pipeline/storage.py - Qdrant統合

     処理フロー:
     1. チャンク分割: LlamaIndexのSentenceSplitter（512トークン、50オーバーラップ）
     2. 埋め込み生成: Nomic API（nomic-embed-text-v1.5、768次元）
       - バッチ処理（100テキスト/リクエスト）
       - レート制限対応（100 req/min）
     3. ベクトル保存: Qdrant Cloudへアップサート
       - コレクション名: egograph_spotify
       - 距離メトリック: Cosine

     フェーズ4: オーケストレーション（優先度：最高）

     ファイル:
     - src/main.py - パイプライン全体の制御
     - .github/workflows/spotify_ingest.yml - GitHub Actions設定

     main.py実行フロー:
     1. Spotifyからデータ収集（collector）
     2. 統一スキーマへ変換（transformer）
     3. LlamaIndexでチャンク化（etl）
     4. Nomicで埋め込み生成（embeddings）
     5. Qdrantへ保存（storage）

     GitHub Actions:
     - cron: 毎日02:00 UTC
     - workflow_dispatch: 手動実行も可能
     - タイムアウト: 30分
     - 失敗時: ログを7日間保存

     フェーズ5: テストと品質保証（優先度：高）

     ファイル:
     - tests/test_spotify_collector.py
     - tests/test_transformer.py
     - tests/test_etl.py
     - tests/test_integration.py

     テスト戦略:
     - pytestを使用
     - API呼び出しはモック（responsesライブラリ）
     - カバレッジ目標: 80%以上

     依存関係

     Python パッケージ

     # requirements.txt
     pytest>=7.4.0
     python-dotenv>=1.0.0

     # src/ingest/requirements.txt
     spotipy>=2.23.0
     requests>=2.31.0
     tenacity>=8.2.0
     pydantic>=2.5.0

     # src/pipeline/requirements.txt
     llama-index>=0.10.0
     qdrant-client>=1.7.0
     tenacity>=8.2.0

     外部サービス

     1. Spotify Web API
       - 無料枠: あり
       - レート制限: 180 req/min/user
     2. Nomic API
       - 無料枠: 100万埋め込み/月、100 req/min
       - MVP推定: 50曲/日 × 30日 = 1,500曲/月（十分）
     3. Qdrant Cloud
       - 無料枠: 1GB ストレージ
       - MVP推定: 50曲/日 × 365日 = 18K ベクトル/年（十分）
     4. GitHub Actions
       - 無料枠: 2,000分/月（プライベートリポジトリ）
       - 推定使用: 5分/日 = 150分/月（十分）

     ユーザーが行う必要がある作業

     1. APIクレデンシャル取得（詳細は docs/plan/02.api_keys.md）

     - Spotify Developer Dashboard でアプリ作成
     - Nomic Atlas でAPIキー生成
     - Qdrant Cloud でクラスタ作成

     2. GitHub Secrets 設定（詳細は docs/plan/03.github_secrets.md）

     必須シークレット:
     - SPOTIFY_CLIENT_ID
     - SPOTIFY_CLIENT_SECRET
     - SPOTIFY_REFRESH_TOKEN
     - NOMIC_API_KEY
     - QDRANT_URL
     - QDRANT_API_KEY

     3. GitHub Actions 有効化

     - リポジトリの Actions タブで有効化
     - 手動実行でテスト

     推定所要時間: 1-2時間

     データフロー詳細

     Spotify API
         ↓ (OAuth 2.0)
     SpotifyCollector
         ↓ (生JSONデータ)
     SpotifyTransformer
         ↓ (UnifiedDataModel)
     ETLPipeline (LlamaIndex)
         ↓ (TextNode)
     NomicEmbedder
         ↓ (768次元ベクトル)
     QdrantStorage
         ↓ (gRPC/HTTP)
     Qdrant Cloud

     重要な実装ファイル（優先順位）

     1. src/shared/models.py - 全てのコンポーネントが依存する基盤
     2. src/ingest/spotify/collector.py - データ収集の入口、OAuth処理
     3. src/pipeline/etl.py - LlamaIndexの中核処理
     4. src/main.py - パイプライン全体の制御
     5. .github/workflows/spotify_ingest.yml - 自動化の要

     セキュリティ考慮事項

     - シークレット管理: GitHub Secrets のみ使用（.envファイルはコミット禁止）
     - 最小権限の原則: 必要なOAuthスコープのみ付与
     - データ分類: Spotifyデータは全て "low" sensitivity（MVP）
     - ロギング: 全パイプライン実行をログ記録（デバッグ用）

     パフォーマンス見積もり

     - Spotify API呼び出し（50曲）: ~2秒
     - データ変換: <1秒
     - LlamaIndexチャンク化: ~1秒/100アイテム
     - Nomic埋め込み（バッチ100）: ~3-5秒
     - Qdrantアップサート（バッチ1000）: ~2-3秒

     合計実行時間: 日次実行で5-10分（GitHub Actions制限内）

     今後の拡張

     MVP完成後の改善案:
     1. データ重複排除（track_id ベース）
     2. インクリメンタル更新（前回実行以降のデータのみ）
     3. オーディオ特徴量の追加（tempo、energy、danceability）
     4. データ品質モニタリング
     5. コスト最適化（スマートバッチング）

     トラブルシューティング

     よくある問題:
     - Spotifyトークン期限切れ → リフレッシュトークンの再取得
     - レート制限エラー → エクスポネンシャルバックオフで再試行
     - Qdrant接続エラー → URLとAPIキーを確認
     - GitHub Actions失敗 → Actionsタブでログを確認

     詳細は docs/plan/04.troubleshooting.md を参照

     実装推定期間

     - Week 1: 基盤構築 + データ収集 + ETLパイプライン（Day 1-7）
     - Week 2: ストレージ統合 + オーケストレーション + ドキュメント（Day 8-14）

     合計: 約2週間でMVP完成