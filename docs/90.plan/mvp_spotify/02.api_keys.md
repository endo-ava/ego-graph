# APIクレデンシャル取得ガイド

このガイドでは、EgoGraphの動作に必要な3つのサービスのAPIクレデンシャルを取得する方法を説明します。

## 1. Spotify API クレデンシャル

### 必要な情報
- `SPOTIFY_CLIENT_ID`
- `SPOTIFY_CLIENT_SECRET`
- `SPOTIFY_REFRESH_TOKEN`

### 手順

#### ステップ1: Spotify Developer Dashboardでアプリを作成

1. https://developer.spotify.com/dashboard にアクセス
2. Spotifyアカウントでログイン（無料アカウントでOK）
3. 「Create app」ボタンをクリック
4. アプリ情報を入力：
   - **App name**: `EgoGraph` （任意の名前）
   - **App description**: `Personal data aggregation system` （任意の説明）
   - **Redirect URI**: `http://127.0.0.1:8888/callback` （重要：正確に入力）
   - **Which API/SDKs are you planning to use?**: Web API にチェック
5. 利用規約に同意して「Save」をクリック

#### ステップ2: Client IDとClient Secretを取得

1. 作成したアプリをクリック
2. 「Settings」ボタンをクリック
3. **Client ID** が表示されているのでコピーして保存
4. 「View client secret」をクリックして **Client Secret** を表示してコピー保存

**重要**: Client Secretは二度と表示されないので安全に保管してください

#### ステップ3: Refresh Tokenを取得

Refresh Tokenの取得は少し複雑です。以下の2つの方法があります：

##### 方法A: Spotify OAuth Helper ツールを使用（推奨）

1. 以下のPythonスクリプトを作成して実行します：

```python
# spotify_auth.py
import spotipy
from spotipy.oauth2 import SpotifyOAuth

# Client IDとClient Secretを入力
CLIENT_ID = "あなたのClient ID"
CLIENT_SECRET = "あなたのClient Secret"
REDIRECT_URI = "http://127.0.0.1:8888/callback"

# 必要なスコープ
SCOPE = "user-read-recently-played playlist-read-private playlist-read-collaborative"

# OAuth認証
sp_oauth = SpotifyOAuth(
    client_id=CLIENT_ID,
    client_secret=CLIENT_SECRET,
    redirect_uri=REDIRECT_URI,
    scope=SCOPE
)

# 認証URLを取得
auth_url = sp_oauth.get_authorize_url()
print(f"以下のURLをブラウザで開いてください:\n{auth_url}\n")

# リダイレクトされたURLを入力
response_url = input("リダイレクトされたURL全体を貼り付けてください: ")

# トークンを取得
code = sp_oauth.parse_response_code(response_url)
token_info = sp_oauth.get_access_token(code)

print(f"\nRefresh Token: {token_info['refresh_token']}")
print("\nこのRefresh Tokenを安全に保管してください！")
```

2. 必要なライブラリをインストール：
```bash
pip install spotipy
```

3. スクリプトを実行：
```bash
python spotify_auth.py
```

4. ブラウザで表示されるURLを開いて認証を承認
5. リダイレクトされたURL（`http://127.0.0.1:8888/callback?code=...`）全体をコピー
6. ターミナルに貼り付けてEnter
7. 表示される **Refresh Token** を保存

##### 方法B: curl で手動取得

1. 認証URLを生成（以下のURLのCLIENT_IDを置き換えてブラウザで開く）：
```
https://accounts.spotify.com/authorize?client_id=CLIENT_ID&response_type=code&redirect_uri=http://127.0.0.1:8888/callback&scope=user-read-recently-played%20playlist-read-private%20playlist-read-collaborative
```

2. 承認後、リダイレクトされたURLから`code`パラメータの値をコピー

3. 以下のcurlコマンドを実行（CLIENT_ID、CLIENT_SECRET、CODEを置き換え）：
```bash
curl -X POST "https://accounts.spotify.com/api/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code" \
  -d "code=CODE" \
  -d "redirect_uri=http://127.0.0.1:8888/callback" \
  -d "client_id=CLIENT_ID" \
  -d "client_secret=CLIENT_SECRET"
```

4. レスポンスのJSONから`refresh_token`の値を保存

### 取得完了チェック

以下の3つの値が揃っていることを確認：
- ✅ `SPOTIFY_CLIENT_ID` (例: `a1b2c3d4e5f6g7h8i9j0`)
- ✅ `SPOTIFY_CLIENT_SECRET` (例: `z9y8x7w6v5u4t3s2r1q0`)
- ✅ `SPOTIFY_REFRESH_TOKEN` (例: `AQD...長い文字列...xyz`)

---

## 2. Nomic API Key

### 必要な情報
- `NOMIC_API_KEY`

### 手順

#### ステップ1: Nomic Atlasでアカウント作成

1. https://atlas.nomic.ai にアクセス
2. 「Sign Up」をクリック
3. GitHubアカウントまたはメールアドレスでサインアップ
4. メール認証を完了（メールアドレスでサインアップした場合）

#### ステップ2: API Keyを生成

1. ログイン後、右上のユーザーアイコンをクリック
2. 「API Keys」または「Settings」を選択
3. 「Create New API Key」をクリック
4. キー名を入力（例: `EgoGraph`）
5. 生成されたAPI Keyをコピーして保存

**重要**: API Keyは一度しか表示されないので、必ず安全に保管してください

### 無料枠の制限

- **月間埋め込み数**: 100万埋め込み/月
- **レート制限**: 100リクエスト/分
- **EgoGraph MVP推定使用量**: 50曲/日 × 30日 = 1,500埋め込み/月（十分な余裕）

### 取得完了チェック

- ✅ `NOMIC_API_KEY` (例: `nk-...長い文字列...`)

---

## 3. Qdrant Cloud クレデンシャル

### 必要な情報
- `QDRANT_URL`
- `QDRANT_API_KEY`

### 手順

#### ステップ1: Qdrant Cloudでアカウント作成

1. https://cloud.qdrant.io にアクセス
2. 「Sign Up」をクリック
3. GitHubアカウントまたはメールアドレスでサインアップ

#### ステップ2: クラスタを作成

1. ログイン後、ダッシュボードで「Create Cluster」をクリック
2. クラスタ設定を選択：
   - **Cluster name**: `egograph-spotify` （任意の名前）
   - **Cloud Provider**: `AWS` または `GCP` （お好みで）
   - **Region**: `us-east-1` （またはあなたの地域に近いリージョン）
   - **Cluster tier**: **Free tier** を選択（1GB、月額$0）
3. 「Create」をクリック
4. クラスタの作成完了を待つ（1-2分）

#### ステップ3: URLとAPI Keyを取得

1. 作成したクラスタをクリック
2. **Cluster URL** が表示されているのでコピー（例: `https://abc123.us-east-1-0.aws.cloud.qdrant.io`）
3. 「API Keys」タブをクリック
4. デフォルトのAPI Keyが表示されているのでコピー
   - または「Create API Key」で新しいキーを生成

### 無料枠の制限

- **ストレージ**: 1GB
- **ノード数**: 1ノード
- **リクエスト制限**: なし
- **EgoGraph MVP推定使用量**:
  - 50曲/日 × 365日 = 18,250ベクトル/年
  - 1ベクトル約1KB = 約18MB/年（1GBの2%未満）

### 取得完了チェック

- ✅ `QDRANT_URL` (例: `https://abc123.us-east-1-0.aws.cloud.qdrant.io`)
- ✅ `QDRANT_API_KEY` (例: `xyz...長い文字列...`)

---

## 全クレデンシャル確認チェックリスト

以下の6つの値が全て揃っていることを確認してください：

```
□ SPOTIFY_CLIENT_ID
□ SPOTIFY_CLIENT_SECRET
□ SPOTIFY_REFRESH_TOKEN
□ NOMIC_API_KEY
□ QDRANT_URL
□ QDRANT_API_KEY
```

## 次のステップ

全てのクレデンシャルを取得したら、次は **[03.github_secrets.md](./03.github_secrets.md)** でGitHub Secretsの設定を行います。

## セキュリティに関する注意

- **これらのクレデンシャルは絶対にGitにコミットしないでください**
- パスワードマネージャー（1Password、Bitwarden等）に保存することを推奨
- 定期的にキーをローテーション（推奨：3-6ヶ月ごと）
- 不正使用の兆候が見られたら即座にキーを再生成
