# EgoGraph プロジェクト設計書

## 1. プロジェクト概要

### 1.1. 目的
本プロジェクト「EgoGraph」の目的は、個人の行動・思考・金融・嗜好などのあらゆるデータを統合し、プライバシーを最優先にした「分身RAG（Retrieval-Augmented Generation）」を自動構築・運用することです。
個人のライフログやデジタルフットプリントを永続的に保持・活用する基盤を作り、これを用いた高度なパーソナルアシスタント機能を実現します。
第一段階のMVP（Minimum Viable Product）として、Spotifyの視聴履歴データの統合を目指します。

### 1.2. 基本方針
*   **ホスティング**: 初期は `Qdrant Cloud` を利用し、将来的にはパブリックとプライベート（NAS上のQdrant）を併用するハイブリッド構成へ移行します。
*   **Embedding**: `Nomic` (hosted API) を採用します。
*   **LLM利用**: 送信前にマスク処理（加工）を行うことを基本とし、必要に応じてデータを送信しない（ローカル処理のみ）モードへ切り替え可能にします。
*   **機密データ扱い**: NSFWやアダルトコンテンツなどの機密性の高いデータは、すべてプライベートDB（NAS上のQdrant）に隔離します。
*   **データ保持期間**: 原則として無制限に保持します。
*   **監査**: 基本的に自分専用システムのためクエリログは必須ではありませんが、オプションで記録可能にします。

---

## 2. システムアーキテクチャ

### 2.1. アーキテクチャ図（概念図）
```
                                                        +--------------------+
                                                        |  Monitoring / APM  |
                                                        |  (Prometheus/Graf.)|
                                                        +--------------------+
                                                                ^
                                                                |
+----------------+        +-----------------+        +----------------------+        +----------------------+
|  Data Sources  | ---→   |  Ingest Layer   | ---→   |  Ingestion Orchestr. | ---→   |   Processing Layer    |
| (Spotify, YT,  |        | (collectors)    |        |  (GitHub Actions /   |        |  (LlamaIndex ETL)     |
|  Browser, bank |        | - Each Source   |        |   Cloud Run cron)    |        |  - chunking           |
|  etc)          |        |                 |        |  - scheduling, logs  |        |  - metadata enrich    |
+----------------+        +-----------------+        +----------------------+        |  - normalize raw_text |
      |                          |                        |                         +----------------------+
      |                          |                        |                                     |
      |                          |                        |                                     v
      |                +----------------------+           |                        +-------------------------------+
      |                |  Preprocessing / SV  |           |                        |  Embedding Layer (Nomic)     |
      |                |  (sanitizer, masker) |           |                        |  - local/hosted embeddings    |
      |                +----------------------+           |                        |  - client-side optional enc   |
      |                          |                        |                        +-------------------------------+
      |                          |                        |                                     |
      |                          v                        |                                     v
      |                +----------------------+           |                        +-------------------------------+
      |                |  Private Gateway /   | ←---------+------------------------|  Vector DB Router (Query)     |
      |                |  Router (API Gate)   |                                    |  - Qdrant_Private (NAS)       |
      |                |  - access control    |                                    |  - Qdrant_Cloud (public)      |
      |                |  - decide store loc  |                                    |  - metadata-level encryption  |
      |                +----------------------+                                    +-------------------------------+
      |                                                                                 |
      |                                                                                 v
      |                                                                         +----------------------+
      |                                                                         | Retrieval / Query    |
      |                                                                         | - LlamaIndex Query   |
      |                                                                         | - Router: select DB  |
      |                                                                         +----------------------+
      |                                                                                 |
      |                                                                                 v
      |                                                                       +---------------------------------+
      |                                                                       |  Application Layer / Backends   |
      |                                                                       |  - FastAPI (RAG endpoints)      |
      |                                                                       |  - Auth (Supabase/Auth0)        |
      |                                                                       |  - Custom prompt mgmt           |
      |                                                                       +---------------------------------+
      |                                                                                  |      |
      |                                                                                  |      v
      |                                                                                  |  +---------------------+
      |                                                                                  |  | Frontend (Next.js)  |
      |                                                                                  |  | - dashboard         |
      |                                                                                  |  | - prompt editor     |
      |                                                                                  |  +---------------------+
      |                                                                                  v
      |                                                                        +----------------------------------+
      |                                                                        |  LLM Chat Interface (DeepSeek)   |
      |                                                                        |  - calls only sanitized ctx      |
      |                                                                        |  - privacy-aware settings        |
      |                                                                        +----------------------------------+

Auxiliary: Secrets (GitHub Secrets / Vault), Backups (S3 / Offsite), CI/CD, Logging (ELK)
```

### 2.2. データフロー
データ処理は以下の流れで行われます：
1.  **収集 (Collection)**: Collectorsが各データソース（API, Gmail, Playwright等）からデータを取得します。
2.  **前処理 (Preprocessing)**: データの正規化・重複除去を行い、SanitizerでPII（個人特定可能情報）のマスクやNSFW（不適切なコンテンツ）の判定・フラグ付けを行います。
3.  **加工 (Processing)**: テキスト化（raw_text）し、LlamaIndexを用いてチャンク分割（chunking）を行います。
4.  **ベクトル化 (Embedding)**: Nomic APIへEmbeddingを要求し、ベクトルデータを生成します。
5.  **保存 (Storage)**: VectorDB Routerがデータの機密度（`sensitivity`）に基づき、Public（Qdrant Cloud）またはPrivate（NAS上のQdrant）へ保存先を振り分けます。
6.  **検索 (Retrieval)**: クエリ実行時、Retrieval層がRouterを参照し、適切なDBから関連ノード（relevant nodes）を取得します。
7.  **生成 (Generation)**: LLM（DeepSeek等）への送信前に再度データをマスクし、プライバシーを保護した状態で回答を生成します。

---

## 3. コンポーネント詳細と技術選定

各レイヤーの実装候補となる技術スタックです。

*   **Collectors**:
    *   Python (requests, Google API libs)
    *   Playwright (明細PDF等の自動ダウンロード)
    *   Android用小型collector (UsageStats)
    *   Chrome拡張機能（ブラウザ履歴）
*   **Orchestrator**:
    *   GitHub Actions (cronジョブでトリガー)
    *   重い処理はCloud RunやVMへジョブとしてオフロード
*   **Preprocessing / Sanitizer**:
    *   Python (regex, dateutil, ヒューリスティック処理)
    *   NSFW判定には軽量LLMまたはヒューリスティックを使用
*   **Indexing**:
    *   LlamaIndex (Node & Document abstractions)
*   **Embedding**:
    *   Nomic hosted API (GitHub SecretsでAPIキー管理)
*   **Vector Database**:
    *   **Public**: Qdrant Cloud (非機密データ)
    *   **Private**: Qdrant on NAS (機密データ)
*   **Backend API**:
    *   FastAPI
    *   認証: Supabase または Auth0
*   **Frontend**:
    *   Next.js (Dashboard, Prompt Editor, Chat UI, Visualization)
*   **LLM**:
    *   DeepSeek v3.2 API (コンテキストをマスクして送信)
*   **Infrastructure & Ops**:
    *   Secrets: GitHub Secrets (初期) → HashiCorp Vault (将来)
    *   Backups: 暗号化スナップショットをS3へ（+オフサイトバックアップ）

---

## 4. データモデル

### 4.1. 共通スキーマ定義
全てのデータソースから得られるデータは、以下の共通スキーマに変換して保存します。

```json
{
  "id": "uuid",
  "source": "spotify|youtube|browser|bank|amazon|gmail|android|pc|steam|switch|note|twitter|adult|maps|calendar",
  "type": "music|video|purchase|email|app_usage|location|event|note|tweet|transaction",
  "timestamp": "ISO8601形式の日時文字列",
  "raw_text": "検索用テキスト本文...",
  "metadata": { /* サービス固有のメタデータ */ },
  "embedding": [/* float配列 */],
  "sensitivity": "low|medium|high",
  "nsfw": true|false
}
```

### 4.2. 収集対象データ
#### MVP (Minimum Viable Product)
*   **Spotify**: 視聴履歴、プレイリスト

#### 今後の収集予定
*   **メディア**: YouTube（視聴履歴、検索語）
*   **ブラウジング**: Chrome/Firefox 履歴
*   **金融**: 銀行・クレジットカード・証券（Gmailの領収書、PDF解析）
*   **EC**: Amazon購入履歴
*   **コミュニケーション**: Gmail（ラベルベース）、Twitter (X) 履歴
*   **行動ログ**: Google Maps Timeline、PC/Androidアプリ起動履歴
*   **スケジュール**: Google Calendar
*   **ゲーム**: Steam, Nintendo Switch
*   **ナレッジ**: メモアプリ (Notion / Obsidian)
*   **その他**: アダルト系閲覧履歴（隔離対象）

---

## 5. セキュリティと運用

### 5.1. セキュリティ対策チェックリスト
*   [ ] **Secret管理**: 初期はGitHub Secretsに必要な鍵のみを格納。
*   [ ] **通信**: すべてTLSで暗号化。
*   [ ] **Private DB保護**: NAS上のPrivate QdrantはFirewallおよびVPNの背後に配置。
*   [ ] **マスキング**: LLM送信前にPII（個人情報）を除去する処理を徹底。
*   [ ] **バックアップ**: 週次フルバックアップ、日次差分バックアップ（暗号化済み）。
*   [ ] **キーローテーション**: APIキーの定期的な変更。
*   [ ] **監視**: 閾値を設けて不審なクエリを検知。

### 5.2. ディレクトリ構成案 (初期)
```
repo-root/
├─ backend/                 ← FastAPI (RAG API / Prompt Engine)
│   ├─ app/
│   └─ requirements.txt
│
├─ frontend/                ← Next.js (Dashboard / Chat UI)
│   ├─ app/
│   ├─ public/
│   └─ package.json
│
├─ ingest/                  ← データ収集・加工 (GitHub Actionsで実行)
│   ├─ spotify/
│   ├─ youtube/
│   ├─ browser/
│   ├─ finance/
│   ├─ nomic_embeddings/
│   ├─ llama_index_pipelines/
│   └─ requirements.txt
│
├─ .github/
│   └─ workflows/
│       ├─ ingest_spotify.yaml
│       ├─ ingest_youtube.yaml
│       └─ ...
│
└─ shared/                  ← 共有ロジック（必要に応じて）
    └─ utils/
```

### 5.3. 自動化ワークフロー例 (GitHub Actions)
Spotifyデータの収集を行うワークフローの雛形です (`.github/workflows/spotify-ingest.yml`)。

```yaml
name: spotify-ingest
on:
  schedule:
    - cron: '0 2 * * *' # 毎日 02:00 UTC に実行
  workflow_dispatch: {}
jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install -r src/ingest/requirements.txt # パスは構成に合わせて調整
      - name: Run spotify ingest
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          NOMIC_API_KEY: ${{ secrets.NOMIC_API_KEY }}
        run: python src/ingest/spotify/main.py
```

---

## 6. 成果物定義 (Deliverables)

本プロジェクトで作成するもの：
1.  **アーキテクチャ図**: 最終版のPNG/SVGデータ。
2.  **Spotify MVPリポジトリ**: 収集スクリプト、GitHub Actions設定、LlamaIndexパイプラインを含む雛形。
3.  **DBスキーマ**: Qdrantのコレクション定義とインポートスクリプト。
4.  **Embedding実装**: Nomic API呼び出しのサンプルコード。
5.  **APIサーバー**: FastAPIによるRAGクエリエンドポイントのミニマム実装。
6.  **ダッシュボード**: Next.js製の管理・可視化画面の雛形。
7.  **ドキュメント**: セキュリティおよび運用手順書の簡易版。